<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Íµ¨Î°ÄÏ§ë Ï£ºÍ∞ÑÍ≥ÑÌöç</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Íµ¨Î°ÄÏ§ë">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <meta name="theme-color" content="#166534">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .day-cell { min-height: 80px; background-color: white; padding: 4px; position: relative; cursor: pointer; transition: background-color 0.2s; }
        @media (min-width: 768px) { .day-cell { min-height: 140px; padding: 12px; } }
        .day-cell:hover { background-color: #f1f5f9; }

        .event-item { font-size: 13px; padding: 4px 6px; margin-top: 3px; border-radius: 3px; background-color: #f1f5f9; border-left: 2px solid #16a34a; font-weight: 700; display: flex; justify-content: space-between; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        @media (min-width: 768px) { 
            .event-item { font-size: 14px; padding: 6px 8px; margin-top: 5px; border-radius: 5px; border-left-width: 3px; white-space: normal; word-break: break-all; } 
        }

        .dept-ÍµêÎ¨¥ { color: #15803d; border-left-color: #15803d; }
        .dept-Ïó∞Íµ¨ { color: #059669; border-left-color: #059669; }
        .dept-ÌïôÏÉù { color: #d97706; border-left-color: #d97706; }
        .dept-Ï∞ΩÏùò { color: #7c3aed; border-left-color: #7c3aed; }
        .dept-ÌñâÏ†ï { color: #475569; border-left-color: #475569; }
        .dept-1ÌïôÎÖÑ { color: #2563eb; border-left-color: #2563eb; }
        .dept-2ÌïôÎÖÑ { color: #db2777; border-left-color: #db2777; }
        .dept-3ÌïôÎÖÑ { color: #0891b2; border-left-color: #0891b2; }
        .dept-ÌïôÏÇ¨ { color: #1e293b; border-left-color: #1e293b; }

        .holiday-badge { font-size: 11px; color: #dc2626; font-weight: 700; margin-top: 1px; }
        @media (min-width: 768px) { .holiday-badge { font-size: 13px; } }

        .text-sun { color: #ef4444; } .text-sat { color: #3b82f6; }
        .del-x { color: #ef4444; cursor: pointer; margin-left: 4px; font-weight: bold; }

        .year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .year-month { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .year-month-title { font-weight: 900; color: #1e293b; margin-bottom: 8px; font-size: 16px; }
        @media (min-width: 768px) { .year-month-title { font-size: 18px; } }

        .mini-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 10px; }
        @media (min-width: 768px) { .mini-calendar { font-size: 12px; } }

        .mini-day { padding: 4px; text-align: center; min-height: 30px; background: #f8fafc; border-radius: 4px; cursor: pointer; }
        @media (min-width: 768px) { .mini-day { min-height: 36px; padding: 6px; } }

        .mini-day.has-event { background: #dcfce7; font-weight: 700; }
        .mini-day.weekend { background: #fee2e2; }

        .week-item { background-color: white; }
        .weekend-bg, .holiday-bg { background-color: #fff1f2 !important; }

        .notice-section { background-color: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .notice-list { display: flex; flex-direction: column; gap: 12px; }
        .notice-box { display: flex; flex-direction: column; gap: 4px; position: relative; }
        .notice-header { display: flex; justify-content: space-between; align-items: center; }
        .notice-label { font-size: 13px; font-weight: 800; color: #15803d; }
        @media (min-width: 768px) { .notice-label { font-size: 15px; } }

        .notice-input { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 14px; outline: none; transition: all 0.2s; min-height: 60px; resize: vertical; background-color: white; font-weight: normal; }
        @media (min-width: 768px) { .notice-input { font-size: 15px; padding: 12px; min-height: 70px; } }

        .notice-input.has-content { background-color: #fef9c3 !important; font-weight: normal !important; border-color: #facc15; }
        .notice-input:focus { border-color: #16a34a; ring: 2px solid #dcfce7; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 80vh; overflow-y: auto; }

        .week-date-label { font-size: 15px; font-weight: 900; line-height: 1.3; }
        @media (min-width: 768px) { .week-date-label { font-size: 17px; } }

        .meeting-container { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        @media (min-width: 768px) { .meeting-container { padding: 20px; } }

        .meeting-calendar-wrapper { max-width: 350px; margin: 0 auto 12px auto; }
        @media (min-width: 768px) { .meeting-calendar-wrapper { max-width: 400px; margin-bottom: 16px; } }

        .meeting-calendar-header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 6px 10px; border-radius: 6px 6px 0 0; color: white; }
        @media (min-width: 768px) { .meeting-calendar-header { padding: 8px 12px; } }

        .meeting-calendar-header button { background: rgba(255,255,255,0.2); color: white; font-weight: bold; padding: 3px 8px; border-radius: 4px; font-size: 12px; transition: all 0.2s; }
        @media (min-width: 768px) { .meeting-calendar-header button { padding: 4px 10px; font-size: 14px; } }
        .meeting-calendar-header button:hover { background: rgba(255,255,255,0.3); }

        .meeting-calendar-title { font-size: 12px; font-weight: 900; }
        @media (min-width: 768px) { .meeting-calendar-title { font-size: 16px; } }

        .meeting-calendar-body { background: white; border: 2px solid #16a34a; border-top: none; border-radius: 0 0 6px 6px; padding: 4px; }
        @media (min-width: 768px) { .meeting-calendar-body { padding: 6px; } }

        .meeting-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
        @media (min-width: 768px) { .meeting-calendar-grid { gap: 2px; } }

        .meeting-calendar-day-header { text-align: center; font-weight: 700; color: #64748b; padding: 2px; font-size: 9px; }
        @media (min-width: 768px) { .meeting-calendar-day-header { font-size: 10px; padding: 3px; } }

        .meeting-calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 10px;
            transition: all 0.2s;
            background: #f8fafc;
        }
        @media (min-width: 768px) { .meeting-calendar-day { font-size: 12px; border-radius: 6px; } }

        .meeting-calendar-day:hover { background: #e0f2fe; transform: scale(1.05); }
        .meeting-calendar-day.selected { background: #16a34a; color: white; font-weight: 900; box-shadow: 0 1px 4px rgba(22, 163, 74, 0.3); }
        .meeting-calendar-day.today { border: 1.5px solid #facc15; }
        .meeting-calendar-day.weekend { background: #fef2f2; }
        .meeting-calendar-day.other-month { color: #cbd5e1; background: transparent; font-size: 9px; }
        .meeting-calendar-day.has-meeting { background: #dcfce7; font-weight: 800; }

        .meeting-input-group { margin-bottom: 12px; }
        @media (min-width: 768px) { .meeting-input-group { margin-bottom: 16px; } }

        .meeting-label { font-size: 13px; font-weight: 800; color: #15803d; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        @media (min-width: 768px) { .meeting-label { font-size: 15px; margin-bottom: 6px; } }

        .ai-generate-btn { 
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); 
            color: white; 
            padding: 4px 10px; 
            border-radius: 5px; 
            font-size: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(124, 58, 237, 0.3);
        }
        @media (min-width: 768px) { .ai-generate-btn { padding: 5px 12px; font-size: 11px; } }
        .ai-generate-btn:hover { transform: scale(1.05); }

        .meeting-input { width: 100%; border: 2px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 13px; outline: none; transition: all 0.2s; font-weight: 600; }
        @media (min-width: 768px) { .meeting-input { padding: 12px; font-size: 14px; } }
        .meeting-input:focus { border-color: #16a34a; box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1); }

        .meeting-textarea { width: 100%; border: 2px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 12px; outline: none; transition: all 0.2s; min-height: 200px; resize: vertical; line-height: 1.7; }
        @media (min-width: 768px) { .meeting-textarea { padding: 12px; font-size: 13px; min-height: 250px; } }
        .meeting-textarea:focus { border-color: #16a34a; box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1); }

        .meeting-input.has-data, .meeting-textarea.has-data { background-color: #fef9c3; border-color: #facc15; }

        .install-btn { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .install-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .ai-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body class="p-3">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-green-800 p-4 rounded-2xl text-white shadow-lg">
            <h1 class="font-black text-sm md:text-lg">üè´ Íµ¨Î°ÄÏ§ë Ï£ºÍ∞Ñ Í≥ÑÌöç</h1>
            <div class="flex gap-1 md:gap-2">
                <button onclick="app.setView('weekly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold hover:bg-green-600">Ï£ºÍ∞Ñ</button>
                <button onclick="app.setView('monthly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold hover:bg-green-600">ÏõîÍ∞Ñ</button>
                <button onclick="app.setView('yearly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold hover:bg-green-600">Ïó∞Í∞Ñ</button>
                <button onclick="app.setView('meeting')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold hover:bg-green-600">üìùÌöåÏùòÎ©îÎ™®</button>
            </div>
        </header>

        <section id="eventInputSection" class="bg-white p-4 rounded-2xl shadow-sm border mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="date" id="inDate" class="border p-2 rounded-xl text-sm md:text-base outline-none">
            <input type="text" id="inTitle" placeholder="ÏóÖÎ¨¥ ÌñâÏÇ¨ ÏûÖÎ†•" class="border p-2 rounded-xl text-sm md:text-base outline-none">
            <select id="inDept" class="border p-2 rounded-xl text-sm md:text-base outline-none">
                <option>ÍµêÎ¨¥</option><option>Ïó∞Íµ¨</option><option>ÌïôÏÉù</option><option>Ï∞ΩÏùò</option><option>ÌñâÏ†ï</option>
                <option>1ÌïôÎÖÑ</option><option>2ÌïôÎÖÑ</option><option>3ÌïôÎÖÑ</option>
            </select>
            <button onclick="app.saveEvent()" class="bg-green-600 text-white rounded-xl font-bold py-2 text-sm md:text-base hover:bg-green-700">Ï†ÄÏû•ÌïòÍ∏∞</button>
        </section>

        <div class="flex justify-between items-center bg-white p-3 rounded-2xl border mb-4">
            <button onclick="app.move(-1)" class="text-green-600 font-bold px-4 text-lg md:text-xl hover:text-green-800">‚ùÆ</button>
            <h2 id="titleText" class="text-sm md:text-xl font-black text-slate-700">Î°úÎî© Ï§ë...</h2>
            <button onclick="app.move(1)" class="text-green-600 font-bold px-4 text-lg md:text-xl hover:text-green-800">‚ùØ</button>
        </div>

        <div id="viewPort"></div>

        <div id="noticePort" class="hidden">
            <div class="notice-section">
                <h3 class="font-black text-green-800 mb-4 flex items-center gap-2 text-base md:text-lg">üì¢ Ï£ºÍ∞Ñ ÏïàÎÇ¥ÏÇ¨Ìï≠</h3>
                <div class="notice-list">
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ÍµêÏû•</label></div><textarea data-dept="ÍµêÏû•" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ÍµêÍ∞ê</label></div><textarea data-dept="ÍµêÍ∞ê" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ÌñâÏ†ïÏã§Ïû•</label></div><textarea data-dept="ÌñâÏ†ïÏã§" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ÍµêÎ¨¥Î∂Ä</label></div><textarea data-dept="ÍµêÎ¨¥Î∂Ä" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">Ïó∞Íµ¨Î∂Ä</label></div><textarea data-dept="Ïó∞Íµ¨Î∂Ä" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ÌïôÏÉùÎ∂Ä</label></div><textarea data-dept="ÌïôÏÉùÎ∂Ä" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">Ï∞ΩÏùòÏù∏ÏÑ±Î∂Ä</label></div><textarea data-dept="Ï∞ΩÏùòÏù∏ÏÑ±Î∂Ä" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ÌïôÎÖÑÏã§</label></div><textarea data-dept="ÌïôÎÖÑÏã§" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                </div>
            </div>
        </div>

        <footer class="text-center py-8 text-slate-400 text-[10px] md:text-xs">
            ¬© Developed by Choi Gwang-cheol of Gurye Middle School in 2026. All rights reserved.
        </footer>
    </div>

    <button id="installBtn" class="install-btn" style="display: none;">
        üì± Ïï±ÏúºÎ°ú ÏÑ§ÏπòÌïòÍ∏∞
    </button>

    <div id="detailModal" class="modal" onclick="app.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalDate" class="font-black text-green-800 mb-2 text-base md:text-lg"></h3>
            <div id="modalContent" class="space-y-2 max-h-60 overflow-y-auto mb-4 text-sm md:text-base"></div>
            <button onclick="app.closeModal()" class="w-full bg-green-600 text-white font-bold py-2 rounded-xl text-sm md:text-base hover:bg-green-700">Îã´Í∏∞</button>
        </div>
    </div>

    <script>
        const app = {
            API_URL: 'https://script.google.com/macros/s/AKfycbzS9fTLtq_yLujsSLvTkPtZl9CxPkB356GV4Y7KqnnYn0W51H1KydURDK4nriDd6Fw/exec',
            events: [],
            localChanges: {},
            currentDate: new Date(),
            viewMode: 'weekly',
            isSyncing: false,
            isEditing: false,
            meetingInputFocused: false,
            saveTimers: {},
            savingInProgress: false,
            pendingSave: null,
            meetingDate: new Date(),
            meetingCalendarDate: new Date(),
            days: ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'],

            holidays: [
                '2026-01-01:Ïã†Ï†ï', '2026-02-16:ÏÑ§ÎÇ†Ïó∞Ìú¥', '2026-02-17:ÏÑ§ÎÇ†', '2026-02-18:ÏÑ§ÎÇ†Ïó∞Ìú¥',
                '2026-03-01:ÏÇºÏùºÏ†à', '2026-03-02:ÎåÄÏ≤¥Í≥µÌú¥Ïùº', '2026-05-05:Ïñ¥Î¶∞Ïù¥ÎÇ†', '2026-05-24:Î∂ÄÏ≤òÎãòÏò§Ïã†ÎÇ†', 
                '2026-05-25:ÎåÄÏ≤¥Í≥µÌú¥Ïùº', '2026-06-06:ÌòÑÏ∂©Ïùº', '2026-08-15:Í¥ëÎ≥µÏ†à', '2026-08-17:ÎåÄÏ≤¥Í≥µÌú¥Ïùº',
                '2026-09-24:Ï∂îÏÑùÏó∞Ìú¥', '2026-09-25:Ï∂îÏÑù', '2026-09-26:Ï∂îÏÑùÏó∞Ìú¥', '2026-10-03:Í∞úÏ≤úÏ†à', 
                '2026-10-05:ÎåÄÏ≤¥Í≥µÌú¥Ïùº', '2026-10-09:ÌïúÍ∏ÄÎÇ†', '2026-12-25:ÌÅ¨Î¶¨Ïä§ÎßàÏä§'
            ],

            getHoliday(dateStr) {
                const found = this.holidays.find(h => h.startsWith(dateStr));
                return found ? found.split(':')[1] : null;
            },

            isSpecialHoliday(dateStr) {
                return this.events.some(e => e.date === dateStr && (e.title.includes('Ïû¨ÎüâÌú¥ÏóÖÏùº') || e.title.includes('Ìú¥ÏóÖÏùº') || e.title.includes('Ìú¥Î¨¥Ïùº')));
            },

            isMeetingInputActive() {
                const subjectEl = document.getElementById('meetingSubject');
                const contentEl = document.getElementById('meetingContent');
                const activeEl = document.activeElement;
                return (activeEl && (activeEl === subjectEl || activeEl === contentEl));
            },

            async loadFromServer() {
                if (this.isSyncing) return;
                try {
                    this.isSyncing = true;
                    const response = await fetch(this.API_URL + '?t=' + Date.now());
                    const data = await response.json();

                    const serverEvents = data.map(item => {
                        let dateStr = item.date;
                        if (typeof dateStr === 'string' && dateStr.includes('T')) dateStr = dateStr.split('T')[0];
                        else if (typeof dateStr === 'string') dateStr = dateStr.substring(0, 10);
                        return { 
                            id: String(item.id), 
                            date: dateStr, 
                            title: item.title, 
                            dapt: item.dapt,
                            subject: item.subject || '',
                            content: item.content || ''
                        };
                    });

                    this.events = this.mergeEvents(serverEvents);

                    if (this.isEditing || this.meetingInputFocused) return;

                    if (this.viewMode === 'meeting') {
                        this.renderMeetingCalendar();
                        this.softUpdateMeetingInputs();
                    } else {
                        this.render();
                    }
                } catch (error) {
                    console.error('Î°úÎìú Ïò§Î•ò:', error);
                } finally {
                    this.isSyncing = false;
                }
            },

            softUpdateMeetingInputs() {
                if (this.isMeetingInputActive() || this.meetingInputFocused) return;

                const subjectEl = document.getElementById('meetingSubject');
                const contentEl = document.getElementById('meetingContent');
                if (!subjectEl || !contentEl) return;

                const dateStr = this.formatDate(this.meetingDate);
                const meetingId = `meeting_${dateStr}`;
                const meetingData = this.localChanges[meetingId] || this.events.find(e => e.id === meetingId);

                const newSubject = meetingData?.subject || '';
                const newContent = meetingData?.content || '';

                if (subjectEl.value !== newSubject) subjectEl.value = newSubject;
                if (contentEl.value !== newContent) contentEl.value = newContent;

                this.updateMeetingInputStyle(subjectEl);
                this.updateMeetingInputStyle(contentEl);
            },

            mergeEvents(serverEvents) {
                const merged = [...serverEvents];

                Object.keys(this.localChanges).forEach(id => {
                    const localData = this.localChanges[id];
                    const serverIndex = merged.findIndex(e => String(e.id) === String(id));

                    if (serverIndex !== -1) {
                        merged[serverIndex] = { ...merged[serverIndex], ...localData };
                    } else {
                        merged.push(localData);
                    }
                });

                return merged;
            },

            // ‚òÖ Ï†ÄÏû• ÌÅê: ÎèôÏãú ÏöîÏ≤≠ Î∞©ÏßÄ (Ï§ëÎ≥µ Ìñâ ÏõêÏù∏ Ï†úÍ±∞)
            async saveToServer(action, data) {
                if (action === 'add') {
                    this.localChanges[data.id] = data;
                } else if (action === 'delete') {
                    delete this.localChanges[data.id];
                }

                // Ïù¥ÎØ∏ Ï†ÄÏû• Ï§ëÏù¥Î©¥ ÎåÄÍ∏∞Ïó¥Ïóê ÎÑ£Í∏∞
                if (this.savingInProgress) {
                    this.pendingSave = { action, data };
                    return;
                }

                this.savingInProgress = true;

                try {
                    const response = await fetch(this.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action, ...data })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const savedId = data.id;
                        setTimeout(() => {
                            delete this.localChanges[savedId];
                        }, 15000);
                    }
                } catch (error) {
                    console.error('Ï†ÄÏû• Ïò§Î•ò:', error);
                    // Ïã§Ìå®Ìï¥ÎèÑ Ï°∞Ïö©Ìûà - Î°úÏª¨Ïóê Î≥¥Í¥Ä Ï§ëÏù¥ÎØÄÎ°ú Îã§Ïùå Ï†ÄÏû• Ïãú Ïû¨ÏãúÎèÑÎê®
                } finally {
                    this.savingInProgress = false;

                    // ÎåÄÍ∏∞ Ï§ëÏù∏ Ï†ÄÏû•Ïù¥ ÏûàÏúºÎ©¥ Ïã§Ìñâ
                    if (this.pendingSave) {
                        const pending = this.pendingSave;
                        this.pendingSave = null;
                        await this.saveToServer(pending.action, pending.data);
                    }
                }
            },

            handleNoticeInput(input) {
                this.isEditing = true;
                this.updateInputStyle(input);

                const dept = input.dataset.dept;

                if (this.saveTimers[dept]) {
                    clearTimeout(this.saveTimers[dept]);
                }

                this.saveTimers[dept] = setTimeout(() => {
                    this.saveNotice(input);
                }, 2000);
            },

            updateInputStyle(input) {
                if (input.value.trim() !== "") input.classList.add('has-content');
                else input.classList.remove('has-content');
            },

            async saveNotice(input) {
                this.isEditing = false;
                const dept = input.dataset.dept;
                const content = input.value.trim();
                const monday = this.getMonday(this.currentDate);
                const dateStr = this.formatDate(monday);
                const noticeId = `notice_${dateStr}_${dept}`;

                const existingIndex = this.events.findIndex(e => e.id === noticeId);
                if (content === "") {
                    if (existingIndex !== -1) {
                        this.events.splice(existingIndex, 1);
                        await this.saveToServer('delete', { id: noticeId });
                    }
                } else {
                    const newNotice = { id: noticeId, date: dateStr, title: content, dapt: dept };
                    if (existingIndex !== -1) this.events[existingIndex] = newNotice;
                    else this.events.push(newNotice);
                    await this.saveToServer('add', newNotice);
                }
            },

            async clearNotice(dept) {
                if (!confirm(`${dept} ÏïàÎÇ¥ÏÇ¨Ìï≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
                const monday = this.getMonday(this.currentDate);
                const dateStr = this.formatDate(monday);
                const noticeId = `notice_${dateStr}_${dept}`;
                this.events = this.events.filter(e => e.id !== noticeId);
                const input = document.querySelector(`textarea[data-dept="${dept}"]`);
                if (input) { input.value = ""; this.updateInputStyle(input); }
                await this.saveToServer('delete', { id: noticeId });
                this.render();
            },

            moveMeetingCalendar(direction) {
                this.meetingCalendarDate.setMonth(this.meetingCalendarDate.getMonth() + direction);
                this.renderMeetingCalendar();
            },

            selectMeetingDate(dateStr) {
                this.meetingDate = new Date(dateStr);
                this.loadMeetingData();
                this.renderMeetingCalendar();
            },

            renderMeetingCalendar() {
                const year = this.meetingCalendarDate.getFullYear();
                const month = this.meetingCalendarDate.getMonth();
                const selectedDateStr = this.formatDate(this.meetingDate);
                const today = this.formatDate(new Date());

                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const prevLastDate = new Date(year, month, 0).getDate();

                let html = `
                    <div class="meeting-calendar-wrapper">
                        <div class="meeting-calendar-header">
                            <button onclick="app.moveMeetingCalendar(-1)">‚óÄ</button>
                            <div class="meeting-calendar-title">${year}ÎÖÑ ${month + 1}Ïõî</div>
                            <button onclick="app.moveMeetingCalendar(1)">‚ñ∂</button>
                        </div>
                        <div class="meeting-calendar-body">
                            <div class="meeting-calendar-grid">
                `;

                this.days.forEach(day => {
                    const colorClass = day === 'Ïùº' ? 'text-sun' : (day === 'ÌÜ†' ? 'text-sat' : '');
                    html += `<div class="meeting-calendar-day-header ${colorClass}">${day}</div>`;
                });

                for (let i = firstDay - 1; i >= 0; i--) {
                    const day = prevLastDate - i;
                    html += `<div class="meeting-calendar-day other-month">${day}</div>`;
                }

                for (let day = 1; day <= lastDate; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOfWeek = new Date(year, month, day).getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isToday = dateStr === today;
                    const isSelected = dateStr === selectedDateStr;
                    const hasMeeting = this.events.some(e => e.id === `meeting_${dateStr}`) || !!this.localChanges[`meeting_${dateStr}`];

                    let classes = 'meeting-calendar-day';
                    if (isWeekend) classes += ' weekend';
                    if (isToday) classes += ' today';
                    if (isSelected) classes += ' selected';
                    if (hasMeeting) classes += ' has-meeting';

                    html += `<div class="${classes}" onclick="app.selectMeetingDate('${dateStr}')">${day}</div>`;
                }

                const totalCells = firstDay + lastDate;
                const remainingCells = 7 - (totalCells % 7);
                if (remainingCells < 7) {
                    for (let day = 1; day <= remainingCells; day++) {
                        html += `<div class="meeting-calendar-day other-month">${day}</div>`;
                    }
                }

                html += '</div></div></div>';

                const calendarContainer = document.getElementById('meetingCalendar');
                if (calendarContainer) {
                    calendarContainer.innerHTML = html;
                }
            },

            loadMeetingData() {
                const dateStr = this.formatDate(this.meetingDate);
                const meetingId = `meeting_${dateStr}`;

                const meetingData = this.localChanges[meetingId] || this.events.find(e => e.id === meetingId);

                const subjectInput = document.getElementById('meetingSubject');
                const contentInput = document.getElementById('meetingContent');

                if (subjectInput && contentInput) {
                    subjectInput.value = meetingData?.subject || '';
                    contentInput.value = meetingData?.content || '';

                    this.updateMeetingInputStyle(subjectInput);
                    this.updateMeetingInputStyle(contentInput);
                }
            },

            updateMeetingInputStyle(input) {
                if (input.value.trim() !== "") input.classList.add('has-data');
                else input.classList.remove('has-data');
            },

            handleMeetingInput(input) {
                this.isEditing = true;
                this.meetingInputFocused = true;
                this.updateMeetingInputStyle(input);

                if (this.saveTimers['meeting']) {
                    clearTimeout(this.saveTimers['meeting']);
                }

                this.saveTimers['meeting'] = setTimeout(() => {
                    this.saveMeeting();
                }, 2000);
            },

            handleMeetingFocus() {
                this.meetingInputFocused = true;
                this.isEditing = true;
            },

            handleMeetingBlur() {
                setTimeout(() => {
                    if (!this.isMeetingInputActive()) {
                        this.meetingInputFocused = false;
                        this.isEditing = false;
                    }
                }, 300);
            },

            async saveMeeting() {
                if (!this.isMeetingInputActive()) {
                    this.isEditing = false;
                    this.meetingInputFocused = false;
                }

                const dateStr = this.formatDate(this.meetingDate);
                const subjectEl = document.getElementById('meetingSubject');
                const contentEl = document.getElementById('meetingContent');
                const subject = subjectEl?.value.trim() || '';
                const content = contentEl?.value.trim() || '';
                const meetingId = `meeting_${dateStr}`;

                const existingIndex = this.events.findIndex(e => e.id === meetingId);

                if (subject === '' && content === '') {
                    if (existingIndex !== -1) {
                        this.events.splice(existingIndex, 1);
                        await this.saveToServer('delete', { id: meetingId });
                    }
                } else {
                    const meetingData = {
                        id: meetingId,
                        date: dateStr,
                        title: subject || '(Ï†úÎ™© ÏóÜÏùå)',
                        dapt: 'meeting',
                        subject: subject,
                        content: content
                    };

                    if (existingIndex !== -1) {
                        this.events[existingIndex] = meetingData;
                    } else {
                        this.events.push(meetingData);
                    }

                    await this.saveToServer('add', meetingData);
                }

                this.renderMeetingCalendar();
            },

            async generateAIMeetingMinutes() {
                const contentInput = document.getElementById('meetingContent');
                if (!contentInput || !contentInput.value.trim()) {
                    return;
                }

                const rawContent = contentInput.value.trim();
                const subjectInput = document.getElementById('meetingSubject');
                const subject = subjectInput?.value.trim() || 'ÌöåÏùò';
                const dateStr = this.formatDate(this.meetingDate);
                const dayOfWeek = this.days[this.meetingDate.getDay()];

                contentInput.classList.add('ai-loading');
                contentInput.disabled = true;

                try {
                    const response = await fetch(this.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'generateAI',
                            subject: subject,
                            content: rawContent,
                            date: dateStr,
                            dayOfWeek: dayOfWeek
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        contentInput.value = result.minutes;
                    } else {
                        throw new Error(result.error || 'AI ÏÉùÏÑ± Ïã§Ìå®');
                    }
                } catch (error) {
                    console.error('AI ÏÉùÏÑ± Ïò§Î•ò:', error);
                    contentInput.value = this.formatMeetingMinutesLocal(subject, rawContent, dateStr, dayOfWeek);
                } finally {
                    contentInput.classList.remove('ai-loading');
                    contentInput.disabled = false;
                    this.updateMeetingInputStyle(contentInput);
                    this.handleMeetingInput(contentInput);
                }
            },

            formatMeetingMinutesLocal(subject, rawContent, dateStr, dayOfWeek) {
                const lines = rawContent.split('\n').filter(l => l.trim());

                let formatted = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìã ${subject}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüìÖ ÏùºÏãú: ${dateStr} (${dayOfWeek})\nüìç Ïû•ÏÜå: \nüë• Ï∞∏ÏÑùÏûê: \n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìå Ï£ºÏöî ÏïàÍ±¥\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

                let agendaNum = 1;
                lines.forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('‚Ä¢') || trimmed.startsWith('-') || trimmed.startsWith('*')) {
                        formatted += `${agendaNum}. ${trimmed.substring(1).trim()}\n`;
                        agendaNum++;
                    } else if (trimmed) {
                        formatted += `   ${trimmed}\n`;
                    }
                });

                formatted += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úÖ Í≤∞Ï†ï ÏÇ¨Ìï≠\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚Ä¢ \n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìù ÌäπÏù¥ÏÇ¨Ìï≠ Î∞è ÎπÑÍ≥†\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚Ä¢ \n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìÜ Îã§Ïùå ÌöåÏùò\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nÏùºÏãú: \nÏïàÍ±¥: \n`;

                return formatted;
            },

            renderMeetingView() {
                const dateStr = this.formatDate(this.meetingDate);
                const meetingId = `meeting_${dateStr}`;
                const meetingData = this.localChanges[meetingId] || this.events.find(e => e.id === meetingId);

                const existingContainer = document.querySelector('.meeting-container');
                if (existingContainer && (this.isMeetingInputActive() || this.meetingInputFocused)) {
                    this.renderMeetingCalendar();
                    return;
                }

                const safeSubject = (meetingData?.subject || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
                const safeContent = (meetingData?.content || '').replace(/</g, '&lt;');

                const html = `
                    <div class="meeting-container">
                        <div id="meetingCalendar"></div>

                        <div class="meeting-input-group">
                            <label class="meeting-label">
                                <span>üìã Î™®ÏûÑ Ï£ºÏ†ú</span>
                            </label>
                            <input 
                                type="text" 
                                id="meetingSubject"
                                class="meeting-input ${meetingData?.subject ? 'has-data' : ''}" 
                                placeholder="Ïòà: 1ÌïôÍ∏∞ Ï§ëÍ∞ÑÍ≥†ÏÇ¨ Ï§ÄÎπÑ ÌöåÏùò"
                                value="${safeSubject}"
                                oninput="app.handleMeetingInput(this)"
                                onfocus="app.handleMeetingFocus()"
                                onblur="app.handleMeetingBlur()"
                            >
                        </div>

                        <div class="meeting-input-group">
                            <label class="meeting-label">
                                <span>üìù Î™®ÏûÑ ÎÇ¥Ïö© Ï†ïÎ¶¨</span>
                                <button class="ai-generate-btn" onclick="app.generateAIMeetingMinutes()">
                                    ü§ñ AI ÌöåÏùòÎ°ù
                                </button>
                            </label>
                            <textarea 
                                id="meetingContent"
                                class="meeting-textarea ${meetingData?.content ? 'has-data' : ''}" 
                                placeholder="ÌöåÏùò ÎÇ¥Ïö©ÏùÑ ÏûêÏú†Î°≠Í≤å ÏûëÏÑ±ÌïòÏÑ∏Ïöî.&#10;&#10;ÏòàÏãú:&#10;‚Ä¢ Ï∞∏ÏÑùÏûê: ÍµêÎ¨¥Î∂ÄÏû•, ÌïôÎÖÑÎ∂ÄÏû•&#10;‚Ä¢ Ï£ºÏöî ÏïàÍ±¥: ÏãúÌóò ÏùºÏ†ï Ï°∞Ïú®&#10;‚Ä¢ Í≤∞Ï†ï ÏÇ¨Ìï≠: 4Ïõî 15-17Ïùº Ïã§Ïãú&#10;&#10;üí° AI ÌöåÏùòÎ°ù Î≤ÑÌäºÏúºÎ°ú ÏûêÎèô Î≥ÄÌôò"
                                oninput="app.handleMeetingInput(this)"
                                onfocus="app.handleMeetingFocus()"
                                onblur="app.handleMeetingBlur()"
                            >${safeContent}</textarea>
                        </div>

                        <div class="text-slate-500 text-center mt-3" style="font-size: 10px;">
                            üí° ÏûÖÎ†• 2Ï¥à ÌõÑ ÏûêÎèô Ï†ÄÏû• | üîí ÏûÖÎ†• Ï§ë ÏÉàÎ°úÍ≥†Ïπ® Ïïà Ìï®
                        </div>
                    </div>
                `;

                const viewPort = document.getElementById('viewPort');
                viewPort.innerHTML = html;

                this.meetingCalendarDate = new Date(this.meetingDate);
                this.renderMeetingCalendar();
            },

            getMonday(d) {
                const date = new Date(d);
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(date.setDate(diff));
            },

            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            async saveEvent() {
                const dateInput = document.getElementById('inDate').value;
                const title = document.getElementById('inTitle').value;
                const dapt = document.getElementById('inDept').value;
                if (!dateInput || !title) { alert('ÎÇ†ÏßúÏôÄ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
                const newEvent = { id: Date.now().toString(), date: dateInput, title: title, dapt: dapt };
                this.events.push(newEvent);
                this.render();
                document.getElementById('inDate').value = '';
                document.getElementById('inTitle').value = '';
                await this.saveToServer('add', newEvent);
            },

            async deleteEvent(id) {
                if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                this.events = this.events.filter(e => e.id !== id);
                this.render();
                await this.saveToServer('delete', { id });
                this.closeModal();
            },

            showDetail(dateStr) {
                const modal = document.getElementById('detailModal');
                const modalDate = document.getElementById('modalDate');
                const modalContent = document.getElementById('modalContent');
                const holiday = this.getHoliday(dateStr);
                const d = new Date(dateStr);
                const dayOfWeek = this.days[d.getDay()];

                modalDate.textContent = `${dateStr}(${dayOfWeek})` + (holiday ? ` (${holiday})` : '');
                modalContent.innerHTML = "";

                const dayEvents = this.events.filter(e => e.date === dateStr && !e.id.startsWith('notice_') && !e.id.startsWith('meeting_'));
                const meetingData = this.events.find(e => e.id === `meeting_${dateStr}`);

                if (meetingData) {
                    modalContent.innerHTML += `<div class="bg-green-50 p-4 rounded-lg border-2 border-green-300 mb-3">
                        <div class="text-green-800 font-black mb-2">üìù ÌöåÏùòÎ©îÎ™®</div>
                        <div class="font-bold text-green-700 mb-1">${meetingData.subject || '(Ï†úÎ™© ÏóÜÏùå)'}</div>
                        <div class="text-sm text-slate-600 whitespace-pre-wrap">${meetingData.content || ''}</div>
                    </div>`;
                }

                if (dayEvents.length === 0 && !meetingData) {
                    modalContent.innerHTML = "<div class='text-slate-400 text-sm'>ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.</div>";
                } else if (dayEvents.length > 0) {
                    dayEvents.forEach(e => {
                        modalContent.innerHTML += `<div class="bg-slate-50 p-3 rounded-lg flex justify-between items-center">
                            <div class="dept-${e.dapt}"><span class="font-bold">[${e.dapt}]</span> ${e.title}</div>
                            <span class="del-x text-lg" onclick="app.deleteEvent('${e.id}')">‚úï</span>
                        </div>`;
                    });
                }
                modal.style.display = 'flex';
            },

            closeModal() { document.getElementById('detailModal').style.display = 'none'; },

            move(direction) {
                if (this.viewMode === 'yearly') this.currentDate.setFullYear(this.currentDate.getFullYear() + direction);
                else if (this.viewMode === 'monthly') this.currentDate.setMonth(this.currentDate.getMonth() + direction);
                else if (this.viewMode === 'meeting') {
                    this.meetingCalendarDate.setMonth(this.meetingCalendarDate.getMonth() + direction);
                    this.renderMeetingCalendar();
                }
                else this.currentDate.setDate(this.currentDate.getDate() + (direction * 7));
                this.render();
            },

            setView(mode) { 
                this.viewMode = mode;
                this.meetingInputFocused = false;
                this.isEditing = false;
                this.render(); 
            },

            renderYearly() {
                const year = this.currentDate.getFullYear();
                let html = '<div class="year-view">';
                for (let m = 0; m < 12; m++) {
                    html += `<div class="year-month"><div class="year-month-title">${year}ÎÖÑ ${m + 1}Ïõî</div><div class="mini-calendar">`;
                    this.days.forEach(w => html += `<div class="text-[9px] md:text-[11px] text-slate-400 font-bold text-center p-1">${w}</div>`);
                    const first = new Date(year, m, 1).getDay();
                    const last = new Date(year, m + 1, 0).getDate();
                    for (let i = 0; i < first; i++) html += '<div></div>';
                    for (let d = 1; d <= last; d++) {
                        const dateStr = `${year}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        const dayIdx = new Date(year, m, d).getDay();
                        const hasEvent = this.events.some(e => e.date === dateStr && !e.id.startsWith('notice_'));
                        const holiday = this.getHoliday(dateStr);
                        const isSpecial = this.isSpecialHoliday(dateStr);
                        const isWeekend = dayIdx === 0 || dayIdx === 6;
                        const colorClass = dayIdx === 0 || holiday ? 'text-sun' : (dayIdx === 6 ? 'text-sat' : 'text-slate-600');
                        const holidayClass = (holiday || isSpecial || isWeekend) ? 'holiday-bg' : '';
                        const cellClass = holiday || isWeekend ? 'weekend' : (hasEvent ? 'has-event' : '');
                        html += `<div class="mini-day ${cellClass} ${colorClass} ${holidayClass}" onclick="app.showDetail('${dateStr}')">${d}</div>`;
                    }
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            renderMonthly() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                let html = '<div class="calendar-grid">';
                this.days.forEach(w => html += `<div class="bg-slate-50 p-2 text-center text-[10px] md:text-sm font-bold text-slate-400">${w}</div>`);
                const first = new Date(year, month, 1).getDay();
                const last = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < first; i++) html += '<div class="day-cell bg-slate-50/30"></div>';
                for (let d = 1; d <= last; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayIdx = new Date(year, month, d).getDay();
                    const holiday = this.getHoliday(dateStr);
                    const isSpecial = this.isSpecialHoliday(dateStr);
                    const isWeekend = dayIdx === 0 || dayIdx === 6;
                    const colorClass = dayIdx === 0 || holiday ? 'text-sun' : (dayIdx === 6 ? 'text-sat' : 'text-slate-400');
                    const holidayClass = (holiday || isSpecial || isWeekend) ? 'holiday-bg' : '';
                    html += `<div class="day-cell ${holidayClass}" onclick="app.showDetail('${dateStr}')">
                        <div class="text-[10px] md:text-sm font-black ${colorClass}">${d}</div>`;
                    if (holiday) html += `<div class="holiday-badge">${holiday}</div>`;
                    html += '<div class="mt-1">';
                    this.events.filter(e => e.date === dateStr && !e.id.startsWith('notice_') && !e.id.startsWith('meeting_')).forEach(e => {
                        const isMobile = window.innerWidth < 768;
                        const displayTitle = isMobile ? e.title.substring(0, 3) : e.title;
                        html += `<div class="event-item dept-${e.dapt}"><span>${displayTitle}</span></div>`;
                    });
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            renderWeekly() {
                const monday = this.getMonday(this.currentDate);
                const dateStr = this.formatDate(monday);
                if (!this.isEditing) {
                    document.querySelectorAll('.notice-input').forEach(input => {
                        const dept = input.dataset.dept;
                        const noticeId = `notice_${dateStr}_${dept}`;
                        const notice = this.events.find(e => e.id === noticeId);
                        input.value = notice ? notice.title : "";
                        this.updateInputStyle(input);
                    });
                }
                let html = '<div class="flex flex-col gap-2">';
                for (let i = 0; i < 7; i++) {
                    const d = new Date(monday);
                    d.setDate(monday.getDate() + i);
                    const dStr = this.formatDate(d);
                    const holiday = this.getHoliday(dStr);
                    const isSpecial = this.isSpecialHoliday(dStr);
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    const holidayClass = (holiday || isSpecial || isWeekend) ? 'holiday-bg' : '';
                    const dayOfWeek = this.days[d.getDay()];
                    const colorClass = d.getDay() === 0 || holiday ? 'text-sun' : (d.getDay() === 6 ? 'text-sat' : 'text-green-800');

                    html += `<div class="week-item ${holidayClass} p-4 rounded-xl border flex items-center shadow-sm cursor-pointer hover:shadow-md" onclick="app.showDetail('${dStr}')">
                        <div class="w-20 md:w-28 week-date-label font-black ${colorClass} border-r mr-4">${d.getDate()}Ïùº(${dayOfWeek})`;
                    if (holiday) html += `<div class="holiday-badge">${holiday}</div>`;
                    html += '</div><div class="flex-1">';
                    this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_') && !e.id.startsWith('meeting_')).forEach(e => {
                        html += `<div class="event-item mb-1 p-2 dept-${e.dapt}" onclick="event.stopPropagation()">
                            <span>${e.title} (${e.dapt})</span>
                            <span class="del-x" onclick="app.deleteEvent('${e.id}')">‚úï</span>
                        </div>`;
                    });
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            render() {
                const viewPort = document.getElementById('viewPort');
                const titleText = document.getElementById('titleText');
                const noticePort = document.getElementById('noticePort');
                const eventInputSection = document.getElementById('eventInputSection');
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth() + 1;

                if (this.viewMode === 'meeting') {
                    titleText.textContent = `üìù ÌöåÏùòÎ©îÎ™®`;
                    this.renderMeetingView();
                    noticePort.classList.add('hidden');
                    eventInputSection.classList.add('hidden');
                } else {
                    eventInputSection.classList.remove('hidden');
                    if (this.viewMode === 'yearly') {
                        titleText.textContent = `${year}ÎÖÑ Ï†ÑÏ≤¥ ÌïôÏÇ¨Î†•`;
                        viewPort.innerHTML = this.renderYearly();
                        noticePort.classList.add('hidden');
                    } else if (this.viewMode === 'monthly') {
                        titleText.textContent = `${year}ÎÖÑ ${month}Ïõî`;
                        viewPort.innerHTML = this.renderMonthly();
                        noticePort.classList.add('hidden');
                    } else {
                        titleText.textContent = `${year}ÎÖÑ ${month}Ïõî Ï£ºÍ∞ÑÍ≥ÑÌöç`;
                        viewPort.innerHTML = this.renderWeekly();
                        noticePort.classList.remove('hidden');
                    }
                }
            },

            async init() {
                await this.loadFromServer();
                this.render();

                setInterval(() => { 
                    if (!this.isEditing && !this.meetingInputFocused) {
                        this.loadFromServer(); 
                    }
                }, 10000);

                window.addEventListener('resize', () => {
                    if (!this.isEditing && !this.meetingInputFocused) {
                        this.render();
                    }
                });
            }
        };
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('‚úÖ Service Worker Îì±Î°ù ÏÑ±Í≥µ'))
                    .catch(err => console.log('‚ùå Service Worker Îì±Î°ù Ïã§Ìå®:', err));
            });
        }

        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            installBtn.style.display = 'none';
        });

        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
        });
    </script>
</body>
</html>