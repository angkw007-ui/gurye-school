<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë¡€ì¤‘ ì£¼ê°„ê³„íš</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="êµ¬ë¡€ì¤‘">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <meta name="theme-color" content="#166534">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; background-color: #f8fafc; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .day-cell { min-height: 80px; background-color: white; padding: 4px; position: relative; cursor: pointer; transition: background-color 0.2s; }
        @media (min-width: 768px) { .day-cell { min-height: 140px; padding: 12px; } }
        .day-cell:hover { background-color: #f1f5f9; }

        /* âœ… 1. ì›”ê°„ ì¼ì • í•œ ì¤„ ì¶œë ¥ ë° ë§ì¤„ì„ ì²˜ë¦¬ */
        .event-item { font-size: 12px; padding: 3px 6px; margin-top: 3px; border-radius: 4px; background-color: #f1f5f9; border-left: 2px solid #16a34a; font-weight: 700; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        @media (min-width: 768px) { .event-item { font-size: 13px; padding: 4px 8px; margin-top: 5px; } }

        /* âœ… 2. ì˜¤ëŠ˜ ë‚ ì§œ ë¹¨ê°„ í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ */
        .today-border { outline: 3px solid #ef4444 !important; outline-offset: -3px; z-index: 10; }

        .dept-êµë¬´ { color: #15803d; border-left-color: #15803d; }
        .dept-ì—°êµ¬ { color: #059669; border-left-color: #059669; }
        .dept-í•™ìƒ { color: #d97706; border-left-color: #d97706; }
        .dept-ì°½ì˜ { color: #7c3aed; border-left-color: #7c3aed; }
        .dept-í–‰ì • { color: #475569; border-left-color: #475569; }
        .dept-1í•™ë…„ { color: #2563eb; border-left-color: #2563eb; }
        .dept-2í•™ë…„ { color: #db2777; border-left-color: #db2777; }
        .dept-3í•™ë…„ { color: #0891b2; border-left-color: #0891b2; }
        .dept-í•™ì‚¬ { color: #1e293b; border-left-color: #1e293b; }
        .dept-meeting { color: #16a34a; border-left-color: #16a34a; }

        .holiday-badge { font-size: 11px; color: #dc2626; font-weight: 700; margin-top: 1px; }
        .text-sun { color: #ef4444; } .text-sat { color: #3b82f6; }
        .del-x { color: #ef4444; cursor: pointer; margin-left: 4px; font-weight: bold; }

        .year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .year-month { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mini-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 10px; }
        .mini-day { padding: 4px; text-align: center; min-height: 30px; background: #f8fafc; border-radius: 4px; cursor: pointer; }
        .mini-day.has-event { background: #dcfce7; font-weight: 700; }
        .mini-day.weekend { background: #fee2e2; }

        .week-item { background-color: white; transition: all 0.2s; }
        .weekend-bg, .holiday-bg { background-color: #fff1f2 !important; }

        .notice-section { background-color: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .notice-input { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 14px; outline: none; min-height: 60px; resize: vertical; }
        .notice-input.has-content { background-color: #fef9c3 !important; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; }

        .install-btn { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 12px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; z-index: 9000; font-size: 13px; border: none; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 12px; font-size: 14px; z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="p-3">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-green-800 p-4 rounded-2xl text-white shadow-lg">
            <h1 class="font-black text-sm md:text-lg">ğŸ« êµ¬ë¡€ì¤‘ ì£¼ê°„ ê³„íš</h1>
            <div class="flex gap-1 md:gap-2">
                <button onclick="app.setView('weekly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold">ì£¼ê°„</button>
                <button onclick="app.setView('monthly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold">ì›”ê°„</button>
                <button onclick="app.setView('yearly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold">ì—°ê°„</button>
                <button onclick="app.setView('meeting')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold">ğŸ“íšŒì˜ë©”ëª¨</button>
            </div>
        </header>

        <section id="eventInputSection" class="bg-white p-4 rounded-2xl shadow-sm border mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="date" id="inDate" class="border p-2 rounded-xl text-sm md:text-base outline-none">
            <input type="text" id="inTitle" placeholder="ì—…ë¬´ í–‰ì‚¬ ì…ë ¥" class="border p-2 rounded-xl text-sm md:text-base outline-none">
            <select id="inDept" class="border p-2 rounded-xl text-sm md:text-base outline-none">
                <option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>ì°½ì˜</option><option>í–‰ì •</option>
                <option>1í•™ë…„</option><option>2í•™ë…„</option><option>3í•™ë…„</option>
            </select>
            <button onclick="app.saveEvent()" class="bg-green-600 text-white rounded-xl font-bold py-2 text-sm md:text-base">ì €ì¥í•˜ê¸°</button>
        </section>

        <div class="flex justify-between items-center bg-white p-3 rounded-2xl border mb-4">
            <button onclick="app.move(-1)" class="text-green-600 font-bold px-4 text-lg md:text-xl">â®</button>
            <h2 id="titleText" class="text-sm md:text-xl font-black text-slate-700">ë¡œë”© ì¤‘...</h2>
            <button onclick="app.move(1)" class="text-green-600 font-bold px-4 text-lg md:text-xl">â¯</button>
        </div>

        <div id="viewPort"></div>

        <div id="noticePort" class="hidden">
            <div class="notice-section">
                <h3 class="font-black text-green-800 mb-4 flex items-center gap-2 text-base md:text-lg">ğŸ“¢ ì£¼ê°„ ì•ˆë‚´ì‚¬í•­</h3>
                <div class="notice-list">
                    <div class="notice-box"><label class="notice-label font-bold text-green-700">êµì¥</label><textarea data-dept="êµì¥" class="notice-input w-full" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><label class="notice-label font-bold text-green-700">êµê°</label><textarea data-dept="êµê°" class="notice-input w-full" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><label class="notice-label font-bold text-green-700">í–‰ì •ì‹¤</label><textarea data-dept="í–‰ì •ì‹¤" class="notice-input w-full" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><label class="notice-label font-bold text-green-700">êµë¬´ë¶€</label><textarea data-dept="êµë¬´ë¶€" class="notice-input w-full" oninput="app.handleNoticeInput(this)"></textarea></div>
                </div>
            </div>
        </div>

        <footer class="text-center py-8 text-slate-400 text-[10px]">
            Â© Developed by Choi Gwang-cheol of Gurye Middle School in 2026.
        </footer>
    </div>

    <div id="detailModal" class="modal" onclick="app.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalDate" class="font-black text-green-800 mb-2"></h3>
            <div id="modalContent" class="space-y-2 mb-4"></div>
            <button onclick="app.closeModal()" class="w-full bg-green-600 text-white font-bold py-2 rounded-xl">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const app = {
            API_URL: 'https://script.google.com/macros/s/AKfycbxf0a56E_z4mlSr3b8xpii24MDEXNEHHUaV261J7wFgse6y_3qg4Uj2bC6y58GI4776/exec',
            events: [],
            currentDate: new Date(),
            viewMode: 'weekly',
            days: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],
            holidays: ['2026-01-01:ì‹ ì •', '2026-03-01:ì‚¼ì¼ì ˆ', '2026-05-05:ì–´ë¦°ì´ë‚ '], // ì˜ˆì‹œ

            // âœ… 3. ë‚ ì§œ ì˜¤ë¥˜ í•´ê²° (ë¡œì»¬ íƒ€ì„ì¡´ ê°•ì œ ì§€ì •)
            parseLocalDate(dateStr) {
                return new Date(dateStr + 'T00:00:00');
            },

            formatDate(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            },

            // âœ… 2. ì˜¤ëŠ˜ ë‚ ì§œ ì²´í¬
            isToday(dateStr) {
                return dateStr === this.formatDate(new Date());
            },

            async loadFromServer() {
                try {
                    const res = await fetch(this.API_URL + '?t=' + Date.now());
                    const data = await res.json();
                    this.events = data.map(i => ({...i, date: i.date.split('T')[0]}));
                    this.render();
                } catch(e) { console.error(e); }
            },

            renderYearly() {
                const year = this.currentDate.getFullYear();
                let html = '<div class="year-view">';
                for (let m = 0; m < 12; m++) {
                    html += `<div class="year-month"><div class="font-black mb-2">${m+1}ì›”</div><div class="mini-calendar">`;
                    for (let d = 1; d <= new Date(year, m+1, 0).getDate(); d++) {
                        const dStr = `${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const todayClass = this.isToday(dStr) ? 'today-border' : '';
                        html += `<div class="mini-day ${todayClass}" onclick="app.showDetail('${dStr}')">${d}</div>`;
                    }
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            renderMonthly() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                let html = '<div class="calendar-grid">';
                this.days.forEach(d => html += `<div class="bg-slate-50 p-2 text-center text-[10px] font-bold text-slate-400">${d}</div>`);
                const last = new Date(year, month + 1, 0).getDate();
                for (let d = 1; d <= last; d++) {
                    const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const todayClass = this.isToday(dStr) ? 'today-border' : '';
                    html += `<div class="day-cell ${todayClass}" onclick="app.showDetail('${dStr}')">
                        <div class="text-[10px] font-black">${d}</div>`;
                    this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_')).forEach(e => {
                        html += `<div class="event-item dept-${e.dapt}">${e.title}</div>`;
                    });
                    html += '</div>';
                }
                return html + '</div>';
            },

            renderWeekly() {
                const monday = this.getMonday(this.currentDate);
                let html = '<div class="flex flex-col gap-2">';
                for (let i = 0; i < 7; i++) {
                    const d = new Date(monday); d.setDate(monday.getDate() + i);
                    const dStr = this.formatDate(d);
                    const todayClass = this.isToday(dStr) ? 'today-border' : '';
                    html += `<div class="week-item p-4 rounded-xl border flex items-center ${todayClass}" onclick="app.showDetail('${dStr}')">
                        <div class="w-20 font-black border-r mr-4">${d.getDate()}ì¼(${this.days[d.getDay()]})</div>
                        <div class="flex-1">`;
                    this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_')).forEach(e => {
                        html += `<div class="event-item dept-${e.dapt}">${e.title}</div>`;
                    });
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            getMonday(d) {
                const date = new Date(d);
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(date.getFullYear(), date.getMonth(), diff);
            },

            async saveEvent() {
                const d = document.getElementById('inDate').value;
                const t = document.getElementById('inTitle').value;
                if(!d || !t) return;
                const ne = { id: Date.now().toString(), date: d, title: t, dapt: document.getElementById('inDept').value };
                this.events.push(ne);
                this.currentDate = this.parseLocalDate(d); // âœ… ì˜¤ë¥˜ ìˆ˜ì • ì ìš©
                this.render();
                // ì„œë²„ ì €ì¥ ë¡œì§ ìƒëµ(ê¸°ì¡´ API_URL ì‚¬ìš©)
            },

            setView(m) { this.viewMode = m; this.render(); },
            move(n) {
                if(this.viewMode==='monthly') this.currentDate.setMonth(this.currentDate.getMonth()+n);
                else if(this.viewMode==='yearly') this.currentDate.setFullYear(this.currentDate.getFullYear()+n);
                else this.currentDate.setDate(this.currentDate.getDate()+(n*7));
                this.render();
            },

            render() {
                const vp = document.getElementById('viewPort');
                const tt = document.getElementById('titleText');
                const np = document.getElementById('noticePort');
                if(this.viewMode==='monthly') { tt.textContent=`${this.currentDate.getFullYear()}ë…„ ${this.currentDate.getMonth()+1}ì›”`; vp.innerHTML=this.renderMonthly(); np.classList.add('hidden'); }
                else if(this.viewMode==='yearly') { tt.textContent=`${this.currentDate.getFullYear()}ë…„ í•™ì‚¬ë ¥`; vp.innerHTML=this.renderYearly(); np.classList.add('hidden'); }
                else { tt.textContent='ì£¼ê°„ ê³„íš'; vp.innerHTML=this.renderWeekly(); np.classList.remove('hidden'); }
            },
            
            showDetail(d) { /* ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ ë¡œì§ ê·¸ëŒ€ë¡œ ìœ ì§€ */ },
            closeModal() { document.getElementById('detailModal').style.display='none'; }
        };
        app.loadFromServer();
    </script>
</body>
</html>
