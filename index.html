<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë¡€ì¤‘ ì£¼ê°„ê³„íš</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="êµ¬ë¡€ì¤‘">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <meta name="theme-color" content="#166534">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .day-cell { min-height: 100px; background-color: white; padding: 6px; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .day-cell:hover { background-color: #f1f5f9; }
        .event-item { font-size: 12px; padding: 3px 6px; margin-top: 3px; border-radius: 4px; background-color: #f1f5f9; border-left: 3px solid #16a34a; font-weight: 700; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .dept-êµë¬´ { color: #15803d; border-left-color: #15803d; } .dept-ì—°êµ¬ { color: #059669; border-left-color: #059669; } .dept-í•™ìƒ { color: #d97706; border-left-color: #d97706; } .dept-ì°½ì˜ { color: #7c3aed; border-left-color: #7c3aed; } .dept-í–‰ì • { color: #475569; border-left-color: #475569; }
        .holiday-badge { font-size: 11px; color: #dc2626; font-weight: 700; }
        .text-sun { color: #ef4444; } .text-sat { color: #3b82f6; }
        .del-x { color: #ef4444; cursor: pointer; float: right; font-weight: bold; }
        .year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .year-month { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mini-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 11px; }
        .mini-day { padding: 4px; text-align: center; border-radius: 4px; cursor: pointer; }
        .mini-day.has-event { background: #dcfce7; font-weight: 700; color: #15803d; }
        .notice-input { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; width: 100%; min-height: 60px; font-size: 14px; outline: none; }
        .notice-input:focus { border-color: #16a34a; background-color: #f0fdf4; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 24px; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .meeting-wrapper { display: flex; flex-direction: column; gap: 20px; }
        @media (min-width: 768px) { .meeting-wrapper { flex-direction: row; } }
        .meeting-cal-panel { width: 100%; max-width: 320px; background: white; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; }
        .meeting-calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 8px; font-size: 13px; position: relative; }
        .meeting-calendar-day.selected { background: #16a34a; color: white; font-weight: 900; }
        .meeting-calendar-day.has-meeting::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: #16a34a; border-radius: 50%; }
        .meeting-calendar-day.selected.has-meeting::after { background: white; }
    </style>
</head>
<body class="p-3">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-green-800 p-4 rounded-2xl text-white shadow-lg">
            <h1 class="font-black text-sm md:text-lg">ğŸ« êµ¬ë¡€ì¤‘ ì£¼ê°„ ê³„íš</h1>
            <div class="flex gap-1">
                <button onclick="app.setView('weekly')" class="text-[10px] md:text-sm bg-green-700 px-3 py-2 rounded-lg font-bold">ì£¼ê°„</button>
                <button onclick="app.setView('monthly')" class="text-[10px] md:text-sm bg-green-700 px-3 py-2 rounded-lg font-bold">ì›”ê°„</button>
                <button onclick="app.setView('yearly')" class="text-[10px] md:text-sm bg-green-700 px-3 py-2 rounded-lg font-bold">ì—°ê°„</button>
                <button onclick="app.setView('meeting')" class="text-[10px] md:text-sm bg-green-700 px-3 py-2 rounded-lg font-bold">ğŸ“íšŒì˜</button>
            </div>
        </header>

        <section id="eventInputSection" class="bg-white p-4 rounded-2xl shadow-sm border mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="date" id="inDate" class="border p-2 rounded-xl text-sm outline-none">
            <input type="text" id="inTitle" placeholder="ì—…ë¬´ í–‰ì‚¬ ì…ë ¥" class="border p-2 rounded-xl text-sm outline-none">
            <select id="inDept" class="border p-2 rounded-xl text-sm outline-none">
                <option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>ì°½ì˜</option><option>í–‰ì •</option>
                <option>1í•™ë…„</option><option>2í•™ë…„</option><option>3í•™ë…„</option>
            </select>
            <button onclick="app.saveEvent()" class="bg-green-600 text-white rounded-xl font-bold py-2 text-sm hover:bg-green-700">ì €ì¥í•˜ê¸°</button>
        </section>

        <div class="flex justify-between items-center bg-white p-3 rounded-2xl border mb-4">
            <button onclick="app.move(-1)" class="text-green-600 font-bold px-4 text-xl">â®</button>
            <h2 id="titleText" class="text-sm md:text-xl font-black text-slate-700">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
            <button onclick="app.move(1)" class="text-green-600 font-bold px-4 text-xl">â¯</button>
        </div>

        <div id="viewPort"></div>
        <div id="noticePort" class="hidden mt-6">
            <div class="bg-white p-6 rounded-2xl border">
                <h3 class="font-black text-green-800 mb-4 flex items-center gap-2">ğŸ“¢ ì£¼ê°„ ì•ˆë‚´ì‚¬í•­</h3>
                <div id="noticeList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>
        </div>
        
        <footer class="text-center py-8 text-slate-400 text-[10px]">Â© 2026 Gurye Middle School.</footer>
    </div>

    <div id="detailModal" class="modal" onclick="app.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalDate" class="font-black text-green-800 mb-4 text-lg border-b pb-2"></h3>
            <div id="modalContent" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
            <button onclick="app.closeModal()" class="w-full bg-slate-100 py-3 rounded-xl font-bold">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
    window.app = {
        API_URL: 'https://script.google.com/macros/s/AKfycbyql6pDDPcrI4hxk67-fA1kLjGbT2_qJd8M66wQdd31q--I_k_cH6Hj38EhfbUwsghS/exec',
        events: [], currentDate: new Date(), viewMode: 'weekly', meetingDate: new Date(),
        depts: ['êµì¥','êµê°','í–‰ì •ì‹¤','êµë¬´ë¶€','ì—°êµ¬ë¶€','í•™ìƒë¶€','ì°½ì˜ì¸ì„±ë¶€','í•™ë…„ì‹¤'],
        days: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],
        holidays: ['2026-01-01:ì‹ ì •','2026-03-01:ì‚¼ì¼ì ˆ','2026-05-05:ì–´ë¦°ì´ë‚ ','2026-06-06:í˜„ì¶©ì¼','2026-08-15:ê´‘ë³µì ˆ','2026-10-03:ê°œì²œì ˆ','2026-10-09:í•œê¸€ë‚ ','2026-12-25:í¬ë¦¬ìŠ¤ë§ˆìŠ¤'],

        init: async function() {
            this.renderNoticeInputs();
            await this.loadFromServer();
            // 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹  (ìˆ˜ì • ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
            setInterval(() => { if(!document.activeElement.tagName.match(/INPUT|TEXTAREA/)) this.loadFromServer(); }, 30000);
        },

        renderNoticeInputs: function() {
            const list = document.getElementById('noticeList');
            list.innerHTML = this.depts.map(d => `
                <div>
                    <label class="block text-xs font-bold text-green-700 mb-1">${d}</label>
                    <textarea data-dept="${d}" class="notice-input" onchange="app.saveNotice(this)"></textarea>
                </div>
            `).join('');
        },

        loadFromServer: async function() {
            try {
                const res = await fetch(this.API_URL + '?t=' + Date.now());
                const data = await res.json();
                this.events = data.map(item => ({
                    id: String(item.id), 
                    date: String(item.date).split('T')[0],
                    title: item.title || '', 
                    dapt: item.dapt || '', 
                    subject: item.subject || '', 
                    content: item.content || ''
                }));
                this.render();
            } catch (e) {
                document.getElementById('titleText').textContent = "ì—°ê²° ì˜¤ë¥˜ (ì¸í„°ë„· í™•ì¸)";
            }
        },

        render: function() {
            const vp = document.getElementById('viewPort');
            const title = document.getElementById('titleText');
            const np = document.getElementById('noticePort');
            const y = this.currentDate.getFullYear(), m = this.currentDate.getMonth() + 1;

            if (this.viewMode === 'weekly') {
                title.textContent = `${y}ë…„ ${m}ì›” ì£¼ê°„ê³„íš`;
                np.classList.remove('hidden');
                vp.innerHTML = this.renderWeekly();
            } else if (this.viewMode === 'monthly') {
                title.textContent = `${y}ë…„ ${m}ì›”`;
                np.classList.add('hidden');
                vp.innerHTML = this.renderMonthly();
            } else if (this.viewMode === 'yearly') {
                title.textContent = `${y}ë…„ í•™ì‚¬ë ¥`;
                np.classList.add('hidden');
                vp.innerHTML = this.renderYearly();
            } else {
                title.textContent = `ğŸ“ íšŒì˜ë©”ëª¨`;
                np.classList.add('hidden');
                this.renderMeetingView();
            }
        },

        renderWeekly: function() {
            const mon = this.getMonday(this.currentDate);
            const monStr = this.formatDate(mon);
            
            // ê³µì§€ì‚¬í•­ ê°’ ì±„ìš°ê¸°
            this.depts.forEach(d => {
                const input = document.querySelector(`textarea[data-dept="${d}"]`);
                const found = this.events.find(e => e.id === `notice_${monStr}_${d}`);
                if (input && document.activeElement !== input) input.value = found ? found.title : '';
            });

            let html = '<div class="space-y-3">';
            for(let i=0; i<7; i++) {
                let d = new Date(mon); d.setDate(mon.getDate() + i);
                let dStr = this.formatDate(d);
                let hol = this.getHoliday(dStr);
                let color = (d.getDay()===0 || hol) ? 'text-sun' : (d.getDay()===6 ? 'text-sat' : 'text-slate-700');
                
                html += `
                <div class="bg-white p-4 rounded-xl border shadow-sm flex gap-4 cursor-pointer" onclick="app.showDetail('${dStr}')">
                    <div class="w-16 flex-shrink-0 text-center border-r pr-4">
                        <div class="text-2xl font-black ${color}">${d.getDate()}</div>
                        <div class="text-xs font-bold ${color}">${this.days[d.getDay()]}</div>
                        ${hol ? `<div class="holiday-badge mt-1">${hol}</div>` : ''}
                    </div>
                    <div class="flex-1">
                        ${this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_')).map(e => `
                            <div class="event-item dept-${e.dapt}">${e.title}</div>
                        `).join('')}
                    </div>
                </div>`;
            }
            return html + '</div>';
        },

        renderMonthly: function() {
            const y = this.currentDate.getFullYear(), m = this.currentDate.getMonth();
            let html = '<div class="calendar-grid">';
            this.days.forEach(d => html += `<div class="bg-slate-50 p-2 text-center text-xs font-bold text-slate-400">${d}</div>`);
            
            let first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) html += '<div class="day-cell bg-slate-50/30"></div>';
            for(let d=1; d<=last; d++) {
                let dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let hol = this.getHoliday(dStr);
                html += `
                <div class="day-cell" onclick="app.showDetail('${dStr}')">
                    <span class="text-xs font-bold ${hol?'text-sun':''}">${d}</span>
                    ${this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_')).map(e => `
                        <div class="event-item dept-${e.dapt}" style="font-size:9px; padding:1px 3px;">${e.title}</div>
                    `).join('')}
                </div>`;
            }
            return html + '</div>';
        },

        renderYearly: function() {
            const y = this.currentDate.getFullYear();
            let html = '<div class="year-view">';
            for(let m=0; m<12; m++) {
                html += `<div class="year-month">
                    <div class="font-black text-green-800 mb-2">${m+1}ì›”</div>
                    <div class="mini-calendar">`;
                let first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
                for(let i=0; i<first; i++) html += '<div></div>';
                for(let d=1; d<=last; d++) {
                    let dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    let hasE = this.events.some(e => e.date === dStr && !e.id.startsWith('notice_'));
                    html += `<div class="mini-day ${hasE?'has-event':''}" onclick="app.showDetail('${dStr}')">${d}</div>`;
                }
                html += '</div></div>';
            }
            return html + '</div>';
        },

        renderMeetingView: function() {
            const vp = document.getElementById('viewPort');
            const dStr = this.formatDate(this.meetingDate);
            const data = this.events.find(e => e.id === `meeting_${dStr}`);
            
            vp.innerHTML = `
                <div class="meeting-wrapper">
                    <div class="meeting-cal-panel">
                        <div class="bg-green-700 text-white p-3 flex justify-between items-center">
                            <button onclick="app.moveMeetingCal(-1)">â—€</button>
                            <span class="font-bold">${this.meetingDate.getFullYear()}ë…„ ${this.meetingDate.getMonth()+1}ì›”</span>
                            <button onclick="app.moveMeetingCal(1)">â–¶</button>
                        </div>
                        <div id="meetingCalendarGrid" class="grid grid-cols-7 p-2 text-center"></div>
                    </div>
                    <div class="flex-1 bg-white p-6 rounded-2xl border">
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-400 mb-1">ë‚ ì§œ: ${dStr}</label>
                            <input type="text" id="mSub" class="w-full border-b-2 py-2 font-bold outline-none focus:border-green-600" placeholder="íšŒì˜ ì£¼ì œ" value="${data?.subject||''}">
                        </div>
                        <textarea id="mCon" class="w-full h-64 p-4 bg-slate-50 rounded-xl outline-none resize-none" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">${data?.content||''}</textarea>
                        <button onclick="app.saveMeeting()" class="w-full mt-4 bg-green-600 text-white py-3 rounded-xl font-bold">íšŒì˜ë¡ ì €ì¥</button>
                    </div>
                </div>
            `;
            this.drawMeetingCalendar();
        },

        drawMeetingCalendar: function() {
            const grid = document.getElementById('meetingCalendarGrid');
            if(!grid) return;
            grid.innerHTML = this.days.map(d => `<div class="text-[10px] font-bold text-slate-300 py-1">${d}</div>`).join('');
            
            const y = this.meetingDate.getFullYear(), m = this.meetingDate.getMonth();
            let first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=last; d++) {
                let dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let isSel = dStr === this.formatDate(this.meetingDate);
                let hasM = this.events.some(e => e.id === `meeting_${dStr}`);
                grid.innerHTML += `<div class="meeting-calendar-day ${isSel?'selected':''} ${hasM?'has-meeting':''}" onclick="app.setMeetingDate('${dStr}')">${d}</div>`;
            }
        },

        /* ì´ë²¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜ë“¤ */
        setView: function(m) { this.viewMode = m; this.render(); },
        move: function(dir) {
            if(this.viewMode==='yearly') this.currentDate.setFullYear(this.currentDate.getFullYear()+dir);
            else if(this.viewMode==='monthly') this.currentDate.setMonth(this.currentDate.getMonth()+dir);
            else this.currentDate.setDate(this.currentDate.getDate()+(dir*7));
            this.render();
        },
        moveMeetingCal: function(dir) { this.meetingDate.setMonth(this.meetingDate.getMonth()+dir); this.renderMeetingView(); },
        setMeetingDate: function(dStr) { this.meetingDate = new Date(dStr); this.renderMeetingView(); },
        
        getMonday: function(d) { let date = new Date(d); let day = date.getDay(); let diff = date.getDate() - day + (day === 0 ? -6 : 1); return new Date(date.setDate(diff)); },
        formatDate: function(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); },
        getHoliday: function(dStr) { const found = this.holidays.find(h => h.startsWith(dStr)); return found ? found.split(':')[1] : null; },

        showDetail: function(dStr) {
            const modal = document.getElementById('detailModal');
            document.getElementById('modalDate').textContent = dStr;
            const dayEs = this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_') && !e.id.startsWith('meeting_'));
            document.getElementById('modalContent').innerHTML = dayEs.length ? 
                dayEs.map(e => `<div class="p-3 bg-slate-50 rounded-lg flex justify-between">
                    <span><b>[${e.dapt}]</b> ${e.title}</span>
                    <span class="text-red-500 font-bold cursor-pointer" onclick="app.deleteEvent('${e.id}')">âœ•</span>
                </div>`).join('') : '<div class="text-center text-slate-400 py-10">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            modal.style.display = 'flex';
        },
        closeModal: function() { document.getElementById('detailModal').style.display = 'none'; },

        /* ì„œë²„ ì €ì¥ í•¨ìˆ˜ë“¤ */
        saveEvent: async function() {
            const date = document.getElementById('inDate').value, title = document.getElementById('inTitle').value, dapt = document.getElementById('inDept').value;
            if(!date || !title) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
            await this.sendPost({ action: 'add', id: Date.now().toString(), date, title, dapt });
        },
        deleteEvent: async function(id) {
            if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await this.sendPost({ action: 'delete', id });
            this.closeModal();
        },
        saveNotice: async function(el) {
            const monStr = this.formatDate(this.getMonday(this.currentDate));
            await this.sendPost({ action: 'add', id: `notice_${monStr}_${el.dataset.dept}`, date: monStr, title: el.value, dapt: el.dataset.dept });
        },
        saveMeeting: async function() {
            const dStr = this.formatDate(this.meetingDate);
            await this.sendPost({ action: 'add', id: `meeting_${dStr}`, date: dStr, title: document.getElementById('mSub').value, dapt: 'meeting', subject: document.getElementById('mSub').value, content: document.getElementById('mCon').value });
        },
        sendPost: async function(data) {
            document.getElementById('titleText').textContent = "ì €ì¥ ì¤‘...";
            try {
                await fetch(this.API_URL, { method: 'POST', body: JSON.stringify(data) });
                await this.loadFromServer();
            } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); this.render(); }
        }
    };

    window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
