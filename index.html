<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë¡€ì¤‘ ì£¼ê°„ê³„íš</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="êµ¬ë¡€ì¤‘">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <meta name="theme-color" content="#166534">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .day-cell { min-height: 80px; background-color: white; padding: 4px; position: relative; cursor: pointer; transition: background-color 0.2s; }
        @media (min-width: 768px) { .day-cell { min-height: 140px; padding: 12px; } }
        .day-cell:hover { background-color: #f1f5f9; }
        .event-item { font-size: 13px; padding: 4px 6px; margin-top: 3px; border-radius: 3px; background-color: #f1f5f9; border-left: 2px solid #16a34a; font-weight: 700; display: flex; justify-content: space-between; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        @media (min-width: 768px) { .event-item { font-size: 14px; padding: 6px 8px; margin-top: 5px; border-radius: 5px; border-left-width: 3px; white-space: normal; word-break: break-all; } }
        .dept-êµë¬´ { color: #15803d; border-left-color: #15803d; } .dept-ì—°êµ¬ { color: #059669; border-left-color: #059669; } .dept-í•™ìƒ { color: #d97706; border-left-color: #d97706; } .dept-ì°½ì˜ { color: #7c3aed; border-left-color: #7c3aed; } .dept-í–‰ì • { color: #475569; border-left-color: #475569; } .dept-1í•™ë…„ { color: #2563eb; border-left-color: #2563eb; } .dept-2í•™ë…„ { color: #db2777; border-left-color: #db2777; } .dept-3í•™ë…„ { color: #0891b2; border-left-color: #0891b2; } .dept-í•™ì‚¬ { color: #1e293b; border-left-color: #1e293b; }
        .holiday-badge { font-size: 11px; color: #dc2626; font-weight: 700; margin-top: 1px; }
        @media (min-width: 768px) { .holiday-badge { font-size: 13px; } }
        .text-sun { color: #ef4444; } .text-sat { color: #3b82f6; }
        .del-x { color: #ef4444; cursor: pointer; margin-left: 4px; font-weight: bold; }
        .year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .year-month { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .year-month-title { font-weight: 900; color: #1e293b; margin-bottom: 8px; font-size: 16px; }
        .mini-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 10px; }
        .mini-day { padding: 4px; text-align: center; min-height: 30px; background: #f8fafc; border-radius: 4px; cursor: pointer; }
        .mini-day.has-event { background: #dcfce7; font-weight: 700; }
        .mini-day.weekend { background: #fee2e2; }
        .week-item { background-color: white; }
        .weekend-bg, .holiday-bg { background-color: #fff1f2 !important; }
        .notice-section { background-color: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .notice-list { display: flex; flex-direction: column; gap: 12px; }
        .notice-box { display: flex; flex-direction: column; gap: 4px; position: relative; }
        .notice-label { font-size: 13px; font-weight: 800; color: #15803d; }
        .notice-input { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 14px; outline: none; transition: all 0.2s; min-height: 60px; resize: vertical; background-color: white; font-weight: normal; }
        .notice-input.has-content { background-color: #fef9c3 !important; border-color: #facc15; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 80vh; overflow-y: auto; }
        .week-date-label { font-size: 15px; font-weight: 900; line-height: 1.3; }
        .meeting-wrapper { display: flex; flex-direction: column; gap: 12px; padding-bottom: 40px; }
        @media (min-width: 768px) { .meeting-wrapper { flex-direction: row; align-items: flex-start; gap: 20px; } }
        .meeting-cal-panel { background: white; border-radius: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); overflow: hidden; flex-shrink: 0; }
        @media (min-width: 768px) { .meeting-cal-panel { width: 300px; } }
        .meeting-calendar-header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 10px 14px; color: white; }
        .meeting-calendar-header button { background: rgba(255,255,255,0.25); color: white; font-weight: bold; padding: 4px 10px; border-radius: 6px; font-size: 14px; }
        .meeting-calendar-title { font-size: 15px; font-weight: 900; }
        .meeting-calendar-body { padding: 8px; }
        .meeting-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .meeting-calendar-day-header { text-align: center; font-weight: 700; color: #64748b; padding: 4px 2px; font-size: 11px; }
        .meeting-calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.15s; background: #f8fafc; position: relative; }
        .meeting-calendar-day.selected { background: #16a34a !important; color: white !important; font-weight: 900; box-shadow: 0 2px 6px rgba(22,163,74,0.4); }
        .meeting-calendar-day.today { outline: 2px solid #facc15; outline-offset: -2px; }
        .meeting-calendar-day.weekend { background: #fef2f2; color: #ef4444; }
        .meeting-calendar-day.other-month { color: #cbd5e1; background: transparent; font-size: 10px; }
        .meeting-calendar-day.has-meeting::after { content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; background: #16a34a; }
        .meeting-input-panel { flex: 1; background: white; border-radius: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 16px; min-width: 0; }
        .meeting-panel-title { font-size: 14px; font-weight: 900; color: #15803d; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #dcfce7; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .meeting-date-badge { background: #dcfce7; color: #15803d; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .meeting-label { font-size: 13px; font-weight: 800; color: #374151; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .ai-generate-btn { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .meeting-input { width: 100%; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; font-size: 14px; outline: none; margin-bottom: 12px; }
        .meeting-textarea { width: 100%; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px; font-size: 13px; outline: none; min-height: 300px; resize: vertical; line-height: 1.8; }
        .save-indicator { font-size: 11px; color: #94a3b8; text-align: right; margin-top: 6px; }
        .save-indicator.saving { color: #f59e0b; }
        .save-indicator.saved { color: #16a34a; }
        .install-btn { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 12px 24px; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; display:none;}
    </style>
</head>
<body class="p-3">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-green-800 p-4 rounded-2xl text-white shadow-lg">
            <h1 class="font-black text-sm md:text-lg">ğŸ« êµ¬ë¡€ì¤‘ ì£¼ê°„ ê³„íš</h1>
            <div class="flex gap-1 md:gap-2">
                <button onclick="app.setView('weekly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold">ì£¼ê°„</button>
                <button onclick="app.setView('monthly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold">ì›”ê°„</button>
                <button onclick="app.setView('yearly')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold">ì—°ê°„</button>
                <button onclick="app.setView('meeting')" class="text-[10px] md:text-sm bg-green-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold">ğŸ“íšŒì˜ë©”ëª¨</button>
            </div>
        </header>

        <section id="eventInputSection" class="bg-white p-4 rounded-2xl shadow-sm border mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="date" id="inDate" class="border p-2 rounded-xl text-sm md:text-base outline-none">
            <input type="text" id="inTitle" placeholder="ì—…ë¬´ í–‰ì‚¬ ì…ë ¥" class="border p-2 rounded-xl text-sm md:text-base outline-none">
            <select id="inDept" class="border p-2 rounded-xl text-sm md:text-base outline-none">
                <option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>ì°½ì˜</option><option>í–‰ì •</option>
                <option>1í•™ë…„</option><option>2í•™ë…„</option><option>3í•™ë…„</option>
            </select>
            <button onclick="app.saveEvent()" class="bg-green-600 text-white rounded-xl font-bold py-2 text-sm md:text-base hover:bg-green-700">ì €ì¥í•˜ê¸°</button>
        </section>

        <div class="flex justify-between items-center bg-white p-3 rounded-2xl border mb-4">
            <button onclick="app.move(-1)" class="text-green-600 font-bold px-4 text-lg md:text-xl">â®</button>
            <h2 id="titleText" class="text-sm md:text-xl font-black text-slate-700">ë¡œë”© ì¤‘...</h2>
            <button onclick="app.move(1)" class="text-green-600 font-bold px-4 text-lg md:text-xl">â¯</button>
        </div>

        <div id="viewPort"></div>
        <div id="noticePort" class="hidden">
            <div class="notice-section">
                <h3 class="font-black text-green-800 mb-4 flex items-center gap-2 text-base md:text-lg">ğŸ“¢ ì£¼ê°„ ì•ˆë‚´ì‚¬í•­</h3>
                <div class="notice-list">
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">êµì¥</label></div><textarea data-dept="êµì¥" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">êµê°</label></div><textarea data-dept="êµê°" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">í–‰ì •ì‹¤ì¥</label></div><textarea data-dept="í–‰ì •ì‹¤" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">êµë¬´ë¶€</label></div><textarea data-dept="êµë¬´ë¶€" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ì—°êµ¬ë¶€</label></div><textarea data-dept="ì—°êµ¬ë¶€" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">í•™ìƒë¶€</label></div><textarea data-dept="í•™ìƒë¶€" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">ì°½ì˜ì¸ì„±ë¶€</label></div><textarea data-dept="ì°½ì˜ì¸ì„±ë¶€" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                    <div class="notice-box"><div class="notice-header"><label class="notice-label">í•™ë…„ì‹¤</label></div><textarea data-dept="í•™ë…„ì‹¤" class="notice-input" oninput="app.handleNoticeInput(this)"></textarea></div>
                </div>
            </div>
        </div>
        <footer class="text-center py-8 text-slate-400 text-[10px] md:text-xs">
            Â© Developed by Choi Gwang-cheol of Gurye Middle School in 2026. All rights reserved.
        </footer>
    </div>

    <button id="installBtn" class="install-btn">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</button>

    <div id="detailModal" class="modal" onclick="app.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalDate" class="font-black text-green-800 mb-2 text-base md:text-lg"></h3>
            <div id="modalContent" class="space-y-2 max-h-60 overflow-y-auto mb-4 text-sm md:text-base"></div>
            <button onclick="app.closeModal()" class="w-full bg-green-600 text-white font-bold py-2 rounded-xl">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
    // ì „ì—­ app ê°ì²´ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ìƒì„±
    window.app = {
        API_URL: 'https://script.google.com/macros/s/AKfycbyql6pDDPcrI4hxk67-fA1kLjGbT2_qJd8M66wQdd31q--I_k_cH6Hj38EhfbUwsghS/exec',
        events: [], localChanges: {}, localDeletes: new Set(), currentDate: new Date(),
        viewMode: 'weekly', isSyncing: false, isEditing: false, meetingInputFocused: false,
        saveTimers: {}, savingInProgress: false, pendingSave: null, meetingDate: new Date(),
        meetingCalendarDate: new Date(), days: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],
        holidays: ['2026-01-01:ì‹ ì •','2026-03-01:ì‚¼ì¼ì ˆ','2026-05-05:ì–´ë¦°ì´ë‚ ','2026-06-06:í˜„ì¶©ì¼','2026-08-15:ê´‘ë³µì ˆ','2026-10-03:ê°œì²œì ˆ','2026-10-09:í•œê¸€ë‚ ','2026-12-25:í¬ë¦¬ìŠ¤ë§ˆìŠ¤'],

        getHoliday: function(dStr) { const found = this.holidays.find(h => h.startsWith(dStr)); return found ? found.split(':')[1] : null; },
        formatDate: function(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); },
        getMonday: function(d) { let date = new Date(d); let day = date.getDay(); let diff = date.getDate() - day + (day === 0 ? -6 : 1); return new Date(date.setDate(diff)); },

        async loadFromServer() {
            if (this.isSyncing) return;
            try {
                this.isSyncing = true;
                const res = await fetch(this.API_URL + '?t=' + Date.now());
                const data = await res.json();
                this.events = data.map(item => ({
                    id: String(item.id), date: String(item.date).split('T')[0],
                    title: item.title, dapt: item.dapt, subject: item.subject || '', content: item.content || ''
                }));
                this.render();
            } catch (e) { console.error('Load Error:', e); }
            finally { this.isSyncing = false; }
        },

        render() {
            const vp = document.getElementById('viewPort');
            const title = document.getElementById('titleText');
            const np = document.getElementById('noticePort');
            const eis = document.getElementById('eventInputSection');
            const y = this.currentDate.getFullYear();
            const m = this.currentDate.getMonth() + 1;

            if (this.viewMode === 'meeting') {
                title.textContent = 'ğŸ“ íšŒì˜ë©”ëª¨'; np.classList.add('hidden'); eis.classList.add('hidden'); this.renderMeetingView();
            } else {
                eis.classList.remove('hidden');
                if (this.viewMode === 'yearly') { title.textContent = y+'ë…„ ì „ì²´ í•™ì‚¬ë ¥'; vp.innerHTML = this.renderYearly(); np.classList.add('hidden'); }
                else if (this.viewMode === 'monthly') { title.textContent = y+'ë…„ '+m+'ì›”'; vp.innerHTML = this.renderMonthly(); np.classList.add('hidden'); }
                else { title.textContent = y+'ë…„ '+m+'ì›” ì£¼ê°„ê³„íš'; vp.innerHTML = this.renderWeekly(); np.classList.remove('hidden'); }
            }
        },

        renderYearly() {
            const y = this.currentDate.getFullYear();
            let h = '<div class="year-view">';
            for(let m=0; m<12; m++) {
                h += `<div class="year-month"><div class="year-month-title">${y}ë…„ ${m+1}ì›”</div><div class="mini-calendar">`;
                this.days.forEach(w => h += `<div class="text-[9px] text-slate-400 font-bold text-center">${w}</div>`);
                let first = new Date(y, m, 1).getDay();
                let last = new Date(y, m+1, 0).getDate();
                for(let i=0; i<first; i++) h += '<div></div>';
                for(let d=1; d<=last; d++) {
                    let dStr = y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
                    let hasE = this.events.some(e => e.date === dStr && !e.id.startsWith('notice_'));
                    h += `<div class="mini-day ${hasE?'has-event':''}" onclick="app.showDetail('${dStr}')">${d}</div>`;
                }
                h += '</div></div>';
            }
            return h + '</div>';
        },

        renderMonthly() {
            const y = this.currentDate.getFullYear(), m = this.currentDate.getMonth();
            let h = '<div class="calendar-grid">';
            this.days.forEach(w => h += `<div class="bg-slate-50 p-2 text-center text-[10px] font-bold text-slate-400">${w}</div>`);
            let first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) h += '<div class="day-cell bg-slate-50/30"></div>';
            for(let d=1; d<=last; d++) {
                let dStr = y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
                let hol = this.getHoliday(dStr);
                h += `<div class="day-cell" onclick="app.showDetail('${dStr}')"><div class="text-[10px] font-black">${d}</div>`;
                if(hol) h += `<div class="holiday-badge">${hol}</div>`;
                this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_')).forEach(e => {
                    h += `<div class="event-item dept-${e.dapt}"><span>${e.title}</span></div>`;
                });
                h += '</div>';
            }
            return h + '</div>';
        },

        renderWeekly() {
            const mon = this.getMonday(this.currentDate);
            const dStrMon = this.formatDate(mon);
            document.querySelectorAll('.notice-input').forEach(input => {
                const notice = this.events.find(e => e.id === `notice_${dStrMon}_${input.dataset.dept}`);
                input.value = notice ? notice.title : '';
            });
            let h = '<div class="flex flex-col gap-2">';
            for(let i=0; i<7; i++) {
                let d = new Date(mon); d.setDate(mon.getDate()+i);
                let dStr = this.formatDate(d);
                let hol = this.getHoliday(dStr);
                let color = d.getDay()===0||hol?'text-sun':(d.getDay()===6?'text-sat':'text-green-800');
                h += `<div class="week-item p-4 rounded-xl border flex items-center shadow-sm" onclick="app.showDetail('${dStr}')">
                    <div class="w-20 font-black ${color} border-r mr-4">${d.getDate()}ì¼(${this.days[d.getDay()]})${hol?`<div class="holiday-badge">${hol}</div>`:''}</div>
                    <div class="flex-1">`;
                this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_')).forEach(e => {
                    h += `<div class="event-item mb-1 p-2 dept-${e.dapt}"><span>${e.title}</span><span class="del-x" onclick="event.stopPropagation();app.deleteEvent('${e.id}')">âœ•</span></div>`;
                });
                h += '</div></div>';
            }
            return h + '</div>';
        },

        renderMeetingView() {
            const vp = document.getElementById('viewPort');
            const dStr = this.formatDate(this.meetingDate);
            const data = this.events.find(e => e.id === `meeting_${dStr}`);
            vp.innerHTML = `<div class="meeting-wrapper">
                <div class="meeting-cal-panel"><div id="meetingCalendar"></div></div>
                <div class="meeting-input-panel">
                    <div class="meeting-panel-title">ğŸ“ íšŒì˜ë©”ëª¨ <span class="meeting-date-badge">${dStr}</span></div>
                    <input type="text" id="meetingSubject" class="meeting-input" placeholder="ì£¼ì œ" value="${data?.subject||''}" oninput="app.saveMeetingDebounce()">
                    <textarea id="meetingContent" class="meeting-textarea" oninput="app.saveMeetingDebounce()">${data?.content||''}</textarea>
                    <div id="meetingSaveIndicator" class="save-indicator">ğŸ’¡ ì…ë ¥ 2ì´ˆ í›„ ìë™ ì €ì¥</div>
                </div>
            </div>`;
            this.renderMeetingCalendar();
        },

        renderMeetingCalendar() {
            const cal = document.getElementById('meetingCalendar');
            if(!cal) return;
            const y = this.meetingCalendarDate.getFullYear(), m = this.meetingCalendarDate.getMonth();
            let h = `<div class="meeting-calendar-header"><button onclick="app.moveMeetingCal(-1)">â—€</button><b>${y}ë…„ ${m+1}ì›”</b><button onclick="app.moveMeetingCal(1)">â–¶</button></div><div class="meeting-calendar-grid p-2">`;
            this.days.forEach(d => h += `<div class="text-center text-[11px] font-bold">${d}</div>`);
            let first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) h += '<div></div>';
            for(let d=1; d<=last; d++) {
                let dStr = y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
                let isS = dStr === this.formatDate(this.meetingDate);
                let hasM = this.events.some(e => e.id === `meeting_${dStr}`);
                h += `<div class="meeting-calendar-day ${isS?'selected':''} ${hasM?'has-meeting':''}" onclick="app.selectMeetingDate('${dStr}')">${d}</div>`;
            }
            cal.innerHTML = h + '</div>';
        },

        moveMeetingCal(dir) { this.meetingCalendarDate.setMonth(this.meetingCalendarDate.getMonth()+dir); this.renderMeetingCalendar(); },
        selectMeetingDate(dStr) { this.meetingDate = new Date(dStr); this.renderMeetingView(); },
        setView(mode) { this.viewMode = mode; this.render(); },
        move(dir) {
            if(this.viewMode==='yearly') this.currentDate.setFullYear(this.currentDate.getFullYear()+dir);
            else if(this.viewMode==='monthly') this.currentDate.setMonth(this.currentDate.getMonth()+dir);
            else this.currentDate.setDate(this.currentDate.getDate()+(dir*7));
            this.render();
        },
        showDetail(dStr) {
            const modal = document.getElementById('detailModal');
            document.getElementById('modalDate').textContent = dStr;
            const content = document.getElementById('modalContent');
            const dayEs = this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_'));
            content.innerHTML = dayEs.length ? dayEs.map(e => `<div class="p-2 border-b"><b>[${e.dapt}]</b> ${e.title}</div>`).join('') : 'ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
            modal.style.display = 'flex';
        },
        closeModal() { document.getElementById('detailModal').style.display = 'none'; },

        async saveEvent() {
            const d = document.getElementById('inDate').value, t = document.getElementById('inTitle').value, dp = document.getElementById('inDept').value;
            if(!d || !t) return alert('ì…ë ¥ í™•ì¸');
            const newE = { id: Date.now().toString(), date: d, title: t, dapt: dp, action: 'add' };
            await fetch(this.API_URL, { method: 'POST', body: JSON.stringify(newE) });
            this.loadFromServer();
        },
        async deleteEvent(id) {
            if(!confirm('ì‚­ì œ?')) return;
            await fetch(this.API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: id }) });
            this.loadFromServer();
        },
        saveMeetingDebounce() {
            if(this.saveTimers['meeting']) clearTimeout(this.saveTimers['meeting']);
            this.saveTimers['meeting'] = setTimeout(() => this.saveMeeting(), 2000);
        },
        async saveMeeting() {
            const dStr = this.formatDate(this.meetingDate);
            const sub = document.getElementById('meetingSubject').value, con = document.getElementById('meetingContent').value;
            await fetch(this.API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', id: 'meeting_'+dStr, date: dStr, title: sub, dapt: 'meeting', subject: sub, content: con }) });
            this.loadFromServer();
        }
    };

    // ì´ˆê¸° ì‹¤í–‰
    window.addEventListener('DOMContentLoaded', () => {
        app.loadFromServer();
        setInterval(() => { if(!app.isEditing) app.loadFromServer(); }, 30000);
    });
    </script>
</body>
</html>
