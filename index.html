<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë¡€ì¤‘ ì£¼ê°„ê³„íš</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="êµ¬ë¡€ì¤‘">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <meta name="theme-color" content="#166534">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* [ì›ë³¸ ìŠ¤íƒ€ì¼ ë³µêµ¬] */
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; background-color: #f8fafc; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .day-cell { min-height: 80px; background-color: white; padding: 4px; position: relative; cursor: pointer; transition: background-color 0.2s; }
        @media (min-width: 768px) { .day-cell { min-height: 140px; padding: 12px; } }
        .day-cell:hover { background-color: #f1f5f9; }

        /* ì›”ê°„ ë·° ì´ë²¤íŠ¸ ì•„ì´í…œ: í•œ ì¤„ ìœ ì§€ ë° ë§ì¤„ì„ ì²˜ë¦¬ (ìš”ì²­ ë°˜ì˜) */
        .event-item { font-size: 11px; padding: 2px 4px; margin-top: 2px; border-radius: 3px; background-color: #f1f5f9; border-left: 2px solid #16a34a; font-weight: 700; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        @media (min-width: 768px) { .event-item { font-size: 13px; padding: 4px 6px; margin-top: 4px; border-left-width: 3px; } }

        /* ë¶€ì„œë³„ ìƒ‰ìƒ ë³µêµ¬ */
        .dept-êµë¬´ { color: #15803d; border-left-color: #15803d; }
        .dept-ì—°êµ¬ { color: #059669; border-left-color: #059669; }
        .dept-í•™ìƒ { color: #d97706; border-left-color: #d97706; }
        .dept-ì°½ì˜ { color: #7c3aed; border-left-color: #7c3aed; }
        .dept-í–‰ì • { color: #475569; border-left-color: #475569; }
        .dept-1í•™ë…„ { color: #2563eb; border-left-color: #2563eb; }
        .dept-2í•™ë…„ { color: #db2777; border-left-color: #db2777; }
        .dept-3í•™ë…„ { color: #0891b2; border-left-color: #0891b2; }
        .dept-meeting { color: #16a34a; border-left-color: #16a34a; }

        .holiday-badge { font-size: 10px; color: #dc2626; font-weight: 700; margin-top: 1px; }
        .text-sun { color: #ef4444; } .text-sat { color: #3b82f6; }
        .del-x { color: #ef4444; cursor: pointer; margin-left: 4px; font-weight: bold; }

        /* íšŒì˜ë©”ëª¨ ë° AI ë ˆì´ì•„ì›ƒ ì›ë³¸ ë³µêµ¬ */
        .meeting-wrapper { display: flex; flex-direction: column; gap: 12px; padding-bottom: 40px; }
        @media (min-width: 768px) { .meeting-wrapper { flex-direction: row; align-items: flex-start; gap: 20px; } }
        .meeting-cal-panel { background: white; border-radius: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); overflow: hidden; flex-shrink: 0; }
        @media (min-width: 768px) { .meeting-cal-panel { width: 300px; } }
        .meeting-calendar-header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 10px; color: white; }
        .meeting-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 8px; }
        .meeting-calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; background: #f8fafc; }
        .meeting-calendar-day.selected { background: #16a34a !important; color: white !important; }
        .meeting-card { background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 12px; padding: 14px; margin-bottom: 12px; position: relative; }
        .ai-generate-btn { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .ai-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(124,58,237,0.08); border-radius: 10px; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .ai-spinner { font-size: 13px; color: #7c3aed; font-weight: 700; background: white; padding: 8px 16px; border-radius: 20px; box-shadow: 0 2px 8px rgba(124,58,237,0.2); animation: pulse-ai 1.5s infinite; }
        @keyframes pulse-ai { 0%,100%{opacity:1} 50%{opacity:0.6} }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .install-btn { position: fixed; bottom: 20px; right: 20px; background: #16a34a; color: white; padding: 12px 20px; border-radius: 50px; font-weight: bold; z-index: 9000; }
    </style>
</head>
<body class="p-3">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-green-800 p-4 rounded-2xl text-white shadow-lg">
            <h1 class="font-black text-sm md:text-lg">ğŸ« êµ¬ë¡€ì¤‘ ì£¼ê°„ ê³„íš</h1>
            <div class="flex gap-1 md:gap-2">
                <button onclick="app.setView('weekly')" class="text-[10px] md:text-sm bg-green-700 px-3 py-1.5 rounded-lg font-bold">ì£¼ê°„</button>
                <button onclick="app.setView('monthly')" class="text-[10px] md:text-sm bg-green-700 px-3 py-1.5 rounded-lg font-bold">ì›”ê°„</button>
                <button onclick="app.setView('yearly')" class="text-[10px] md:text-sm bg-green-700 px-3 py-1.5 rounded-lg font-bold">ì—°ê°„</button>
                <button onclick="app.setView('meeting')" class="text-[10px] md:text-sm bg-green-700 px-3 py-1.5 rounded-lg font-bold">ğŸ“íšŒì˜ë©”ëª¨</button>
            </div>
        </header>

        <section id="eventInputSection" class="bg-white p-4 rounded-2xl shadow-sm border mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="date" id="inDate" class="border p-2 rounded-xl text-sm outline-none">
            <input type="text" id="inTitle" placeholder="ì—…ë¬´ í–‰ì‚¬ ì…ë ¥" class="border p-2 rounded-xl text-sm outline-none">
            <select id="inDept" class="border p-2 rounded-xl text-sm outline-none">
                <option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>ì°½ì˜</option><option>í–‰ì •</option>
                <option>1í•™ë…„</option><option>2í•™ë…„</option><option>3í•™ë…„</option>
            </select>
            <button onclick="app.saveEvent()" class="bg-green-600 text-white rounded-xl font-bold py-2 text-sm hover:bg-green-700">ì €ì¥í•˜ê¸°</button>
        </section>

        <div class="flex justify-between items-center bg-white p-3 rounded-2xl border mb-4">
            <button onclick="app.move(-1)" class="text-green-600 font-bold px-4 text-xl">â®</button>
            <h2 id="titleText" class="text-sm md:text-xl font-black text-slate-700 text-center"></h2>
            <button onclick="app.move(1)" class="text-green-600 font-bold px-4 text-xl">â¯</button>
        </div>

        <div id="viewPort"></div>

        <div id="noticePort" class="hidden">
            <div class="bg-white p-6 rounded-2xl border mt-4">
                <h3 class="font-black text-green-800 mb-4">ğŸ“¢ ì£¼ê°„ ì•ˆë‚´ì‚¬í•­</h3>
                <div id="noticeList" class="space-y-4">
                    </div>
            </div>
        </div>

        <footer class="text-center py-8 text-slate-400 text-[10px]">
            Â© Developed by Choi Gwang-cheol of Gurye Middle School in 2026.
        </footer>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-xl text-sm opacity-0 transition-opacity z-[9999]"></div>
    <button id="installBtn" class="install-btn" style="display: none;" onclick="app.handleInstall()">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜</button>
    
    <div id="detailModal" class="modal" onclick="app.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalDate" class="font-black text-green-800 mb-4 text-lg border-b pb-2"></h3>
            <div id="modalContent" class="space-y-3 mb-6"></div>
            <button onclick="app.closeModal()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const app = {
            API_URL: 'https://script.google.com/macros/s/AKfycbxf0a56E_z4mlSr3b8xpii24MDEXNEHHUaV261J7wFgse6y_3qg4Uj2bC6y58GI4776/exec',
            events: [],
            currentDate: new Date(),
            viewMode: 'weekly',
            meetingDate: new Date(),
            meetingCalendarDate: new Date(),
            days: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],
            aiGenerating: false,
            localChanges: {},
            localDeletes: new Set(),

            // âœ… ìˆ˜ì •: ë‚ ì§œ ë°€ë¦¼ ë°©ì§€ íŒŒì„œ
            parseLocalDate(dateStr) {
                if (!dateStr) return new Date();
                return new Date(dateStr + 'T00:00:00');
            },

            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            async loadFromServer() {
                if (this.aiGenerating) return;
                try {
                    const res = await fetch(this.API_URL + '?t=' + Date.now());
                    const data = await res.json();
                    this.events = data.map(i => ({
                        ...i, 
                        date: typeof i.date === 'string' ? i.date.split('T')[0] : i.date,
                        id: String(i.id)
                    }));
                    this.render();
                } catch (e) { console.error('ë¡œë“œ ì‹¤íŒ¨', e); }
            },

            // [AI íšŒì˜ë¡ ìƒì„± ë¡œì§ ì›ë³¸ ë³µêµ¬]
            async generateAIMeetingMinutes(mid) {
                const card = document.querySelector(`.meeting-card[data-mid="${mid}"]`);
                const subject = card.querySelector('[data-field="subject"]').value;
                const contentEl = card.querySelector('[data-field="content"]');
                const content = contentEl.value;

                if (!content) { alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

                this.aiGenerating = true;
                const overlay = document.createElement('div');
                overlay.className = 'ai-overlay';
                overlay.innerHTML = '<div class="ai-spinner">ğŸ¤– AIê°€ íšŒì˜ë¡ì„ ì‘ì„± ì¤‘...</div>';
                contentEl.parentElement.appendChild(overlay);

                try {
                    const res = await fetch(this.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'generateAI', subject, content })
                    });
                    const result = await res.json();
                    if (result.success) {
                        contentEl.value = result.minutes;
                        await this.saveAllCards();
                        alert('AI íšŒì˜ë¡ ì‘ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (e) { alert('AI ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
                finally { overlay.remove(); this.aiGenerating = false; }
            },

            // [ë³µìˆ˜ íšŒì˜ ì¹´ë“œ ì €ì¥ ë¡œì§ ì›ë³¸ ë³µêµ¬]
            async saveAllCards() {
                const dateStr = this.formatDate(this.meetingDate);
                const cards = document.querySelectorAll('.meeting-card');
                for (const [idx, card] of cards.entries()) {
                    const mid = card.dataset.mid.startsWith('__new') ? `meeting_${dateStr}_${idx+1}` : card.dataset.mid;
                    const subject = card.querySelector('[data-field="subject"]').value;
                    const content = card.querySelector('[data-field="content"]').value;
                    
                    if (!subject && !content) continue;

                    const meetingData = { id: mid, date: dateStr, title: subject, dapt: 'meeting', subject, content };
                    await fetch(this.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'add', ...meetingData })
                    });
                }
                this.loadFromServer();
            },

            renderMonthly() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                let html = '<div class="calendar-grid">';
                this.days.forEach(d => html += `<div class="bg-slate-50 p-2 text-center text-[10px] font-bold text-slate-400">${d}</div>`);

                const first = new Date(year, month, 1).getDay();
                const last = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < first; i++) html += '<div class="bg-slate-50/30"></div>';
                for (let d = 1; d <= last; d++) {
                    const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dayIdx = new Date(year, month, d).getDay();
                    const color = dayIdx === 0 ? 'text-sun' : (dayIdx === 6 ? 'text-sat' : 'text-slate-500');
                    
                    html += `<div class="day-cell" onclick="app.showDetail('${dStr}')">
                        <div class="text-[10px] md:text-sm font-black ${color}">${d}</div><div class="mt-1">`;
                    
                    // âœ… ìˆ˜ì •: ì›”ê°„ ë·° ë ˆì´ì•„ì›ƒ ìµœì í™”
                    const dayEvents = this.events.filter(e => e.date === dStr && !e.id.startsWith('notice_'));
                    dayEvents.slice(0, 3).forEach(e => {
                        html += `<div class="event-item dept-${e.dapt}">${e.title}</div>`;
                    });
                    if (dayEvents.length > 3) html += `<div class="text-[9px] text-center text-slate-400">+${dayEvents.length-3}</div>`;
                    
                    html += '</div></div>';
                }
                return html + '</div>';
            },

            renderMeetingView() {
                const dateStr = this.formatDate(this.meetingDate);
                const dayMeetings = this.events.filter(e => e.date === dateStr &&
